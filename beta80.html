<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>editIQ - Advanced 3D Web Editor</title>
    <meta name="description" content="editIQ - Professional 3D web editor for creating stunning visual content. Built by Noskam Amkahc and Makson Chakma. Advanced editing tools with real-time 3D rendering.">
    <meta name="keywords" content="3D editor, web editor, visual editor, Three.js, WebGL, editIQ, Noskam Amkahc, Makson Chakma">
    <meta name="author" content="Noskam Amkahc, Makson Chakma">
    <meta property="og:title" content="editIQ - Advanced 3D Web Editor">
    <meta property="og:description" content="Professional 3D web editor for creating stunning visual content with advanced editing tools and real-time rendering.">
    <meta property="og:type" content="website">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap');

        /* === THEMES === */
        :root {
            --bg-dark: #121214;
            --primary-glow: #00f0ff;
            --accent-color: #0ff;
            --text-light: #eee;
            --panel-bg: #1b1b23;
            --shadow-glow: rgba(0, 255, 255, 0.25);
            --font-family: 'Orbitron', sans-serif;
            --border-color: #333;
            --hover-bg: rgba(0, 255, 255, 0.1);
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --error-color: #ff4444;
        }

        body.theme-purple {
            --primary-glow: #ae00ff;
            --accent-color: #c08cff;
            --shadow-glow: rgba(174, 0, 255, 0.3);
            --panel-bg: #2a1b3d;
            --bg-dark: #1a122a;
        }

        body.theme-red {
            --primary-glow: #ff0055;
            --accent-color: #ff80a5;
            --shadow-glow: rgba(255, 0, 85, 0.3);
            --panel-bg: #3a1b22;
            --bg-dark: #1a1214;
        }

        body.theme-green {
            --primary-glow: #00ff88;
            --accent-color: #66ffaa;
            --shadow-glow: rgba(0, 255, 136, 0.3);
            --panel-bg: #1b3a22;
            --bg-dark: #121a14;
        }

        body.light-mode {
            --bg-dark: #f8f9fa;
            --text-light: #212529;
            --panel-bg: #ffffff;
            --border-color: #dee2e6;
            --hover-bg: rgba(0, 123, 255, 0.1);
            --shadow-glow: rgba(0, 123, 255, 0.15);
        }

        body.light-mode.theme-purple {
            --shadow-glow: rgba(174, 0, 255, 0.15);
        }

        body.light-mode.theme-red {
            --shadow-glow: rgba(255, 0, 85, 0.15);
        }

        body.light-mode.theme-green {
            --shadow-glow: rgba(0, 255, 136, 0.15);
        }

        /* === BASE STYLES === */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            height: 100vh;
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-light);
            display: grid;
            grid-template-columns: 1fr 350px;
            grid-template-rows: 60px 60px 1fr 80px;
            grid-template-areas: 
                "topbar topbar"
                "controls controls"
                "canvas properties"
                "layers layers";
            overflow: hidden;
            user-select: none;
            transition: all 0.3s ease;
        }

        @media (max-width: 1024px) {
            body {
                grid-template-columns: 1fr 300px;
            }
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 60px 1fr 150px 80px;
                grid-template-areas: 
                    "topbar"
                    "controls"
                    "canvas"
                    "properties"
                    "layers";
            }
        }

        button, input, select {
            font-family: var(--font-family);
        }

        button {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* === TOPBAR === */
        header {
            grid-area: topbar;
            background: var(--panel-bg);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 1rem;
            color: var(--primary-glow);
            text-shadow: 0 0 8px var(--primary-glow);
            font-weight: 600;
            font-size: 1.3rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        header .title {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-glow), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            letter-spacing: 0.1em;
            position: relative;
            cursor: pointer;
            animation: logoColorShift 4s ease-in-out infinite, logoFloat 6s ease-in-out infinite, logoPulse 2s ease-in-out infinite;
        }

        @keyframes logoColorShift {
            0% { 
                background: linear-gradient(45deg, #00f0ff, #0ff);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            16% { 
                background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            32% { 
                background: linear-gradient(45deg, #4ecdc4, #7fdddd);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            48% { 
                background: linear-gradient(45deg, #45b7d1, #78c5e0);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            64% { 
                background: linear-gradient(45deg, #96ceb4, #b8dcc6);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            80% { 
                background: linear-gradient(45deg, #feca57, #fed976);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            100% { 
                background: linear-gradient(45deg, #00f0ff, #0ff);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-3px) rotate(1deg); }
            50% { transform: translateY(0px) rotate(0deg); }
            75% { transform: translateY(-2px) rotate(-1deg); }
        }

        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .version-switcher {
            background: transparent;
            border: 2px solid var(--primary-glow);
            color: var(--primary-glow);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .version-switcher:hover {
            background: var(--primary-glow);
            color: var(--bg-dark);
            box-shadow: 0 0 15px var(--primary-glow);
            transform: rotate(180deg);
        }

        .version-text {
            font-size: 0.75rem;
            font-weight: 500;
        }

        header button {
            background: transparent;
            border: 2px solid var(--primary-glow);
            color: var(--primary-glow);
            padding: 6px 12px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            font-size: 0.8rem;
        }

        header button:hover {
            background: var(--primary-glow);
            color: var(--bg-dark);
            box-shadow: 0 0 15px var(--primary-glow);
            transform: translateY(-1px);
        }

        header button:active {
            transform: translateY(0);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--panel-bg);
            border: 2px solid var(--primary-glow);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 0.8rem;
        }

        .user-profile:hover {
            background: var(--primary-glow);
            color: var(--bg-dark);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .beta-badge {
            background: var(--warning-color);
            color: var(--bg-dark);
            padding: 2px 4px;
            border-radius: 8px;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--panel-bg);
            border: 2px solid var(--primary-glow);
            border-radius: 8px;
            padding: 1rem;
            min-width: 200px;
            display: none;
            z-index: 1000;
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .profile-dropdown.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        /* === CONTROLS BAR === */
        .controls-bar {
            grid-area: controls;
            background: var(--panel-bg);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 0.6rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            overflow-x: auto;
        }

        .control-btn {
            background: transparent;
            border: 1px solid var(--primary-glow);
            color: var(--accent-color);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: fit-content;
        }

        .control-btn:hover {
            background: var(--primary-glow);
            color: var(--bg-dark);
            transform: translateY(-1px);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn:disabled:hover {
            background: transparent;
            color: var(--accent-color);
            transform: none;
        }

        .control-btn.active {
            background: var(--primary-glow);
            color: var(--bg-dark);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .preset-selector {
            background: var(--panel-bg);
            border: 1px solid var(--primary-glow);
            color: var(--accent-color);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .preset-selector:focus {
            outline: none;
            box-shadow: 0 0 8px var(--primary-glow);
        }

        /* === EXPORT MODAL === */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--panel-bg);
            margin: 10% auto;
            padding: 2rem;
            border: 2px solid var(--primary-glow);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px var(--primary-glow);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal h2 {
            color: var(--primary-glow);
            margin-top: 0;
            text-align: center;
            font-size: 1.5rem;
        }

        .close {
            color: var(--accent-color);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: var(--primary-glow);
        }

        .export-options {
            display: grid;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .export-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .export-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .export-group label {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .export-group select,
        .export-group input {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-light);
            padding: 8px 12px;
            font-family: var(--font-family);
            transition: all 0.3s ease;
        }

        .export-group select:focus,
        .export-group input:focus {
            outline: none;
            border-color: var(--primary-glow);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .export-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .export-btn {
            background: transparent;
            border: 2px solid var(--primary-glow);
            color: var(--primary-glow);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .export-btn:hover {
            background: var(--primary-glow);
            color: var(--bg-dark);
            box-shadow: 0 0 20px var(--primary-glow);
            transform: translateY(-2px);
        }

        .export-btn.cancel {
            border-color: var(--error-color);
            color: var(--error-color);
        }

        .export-btn.cancel:hover {
            background: var(--error-color);
            color: var(--text-light);
            box-shadow: 0 0 20px var(--error-color);
        }

        /* === CANVAS === */
        main.canvas {
            grid-area: canvas;
            position: relative;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--panel-bg) 100%);
            overflow: hidden;
            margin: 1rem;
            border-radius: 12px;
            box-shadow: 0 0 30px var(--shadow-glow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .canvas-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .canvas-inner {
            position: relative;
            background: var(--bg-dark);
            border: 3px solid var(--primary-glow);
            border-radius: 8px;
            cursor: default;
            overflow: hidden;
            box-shadow: 0 0 20px var(--shadow-glow);
        }

        #glcanvas {
            width: 100%;
            height: 100%;
            border-radius: 5px;
            display: block;
        }

        .canvas-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(27, 27, 35, 0.9);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--accent-color);
            z-index: 100;
            display: flex;
            gap: 15px;
            border: 1px solid var(--border-color);
        }

        .canvas-info span {
            font-weight: 600;
        }

        .canvas-ratio-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(27, 27, 35, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--primary-glow);
            border: 1px solid var(--primary-glow);
            font-weight: 600;
        }

        /* === PROPERTIES PANEL === */
        aside.properties {
            grid-area: properties;
            background: var(--panel-bg);
            padding: 1.5rem;
            border-left: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            font-size: 0.9rem;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            max-height: calc(100vh - 200px);
        }

        aside.properties h2 {
            color: var(--primary-glow);
            font-weight: 700;
            letter-spacing: 0.04em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.8rem;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
        }

        .property-line {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 0.8rem;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .property-line label {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 0.85rem;
            text-align: right;
        }

        .property-line input,
        .property-line select {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-light);
            padding: 6px 10px;
            font-family: var(--font-family);
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .property-line input:focus,
        .property-line select:focus {
            outline: none;
            border-color: var(--primary-glow);
            box-shadow: 0 0 8px var(--primary-glow);
        }

        .property-line input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            cursor: pointer;
        }

        .property-line input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-glow);
            cursor: pointer;
            box-shadow: 0 0 8px var(--primary-glow);
            border: none;
        }

        .property-line input[type="color"] {
            width: 40px;
            height: 30px;
            padding: 2px;
            cursor: pointer;
        }

        .property-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .property-btn {
            background: transparent;
            border: 1px solid var(--primary-glow);
            color: var(--accent-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .property-btn:hover {
            background: var(--primary-glow);
            color: var(--bg-dark);
        }

        /* === ADVANCED STYLING PANEL === */
        .advanced-styling {
            display: none;
            background: var(--panel-bg);
            border: 2px solid var(--primary-glow);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            animation: slideDown 0.3s ease-out;
        }

        .advanced-styling.show {
            display: block;
        }

        .advanced-styling h3 {
            color: var(--primary-glow);
            margin: 0 0 1rem 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .beta-tag {
            background: var(--warning-color);
            color: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .free-tag {
            background: var(--success-color);
            color: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .unlimited-tag {
            background: var(--primary-glow);
            color: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .style-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .style-section h4 {
            color: var(--accent-color);
            margin: 0 0 0.8rem 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .style-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
        }

        .style-grid-full {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.8rem;
        }

        .style-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .style-input-group label {
            color: var(--accent-color);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .style-input-group input,
        .style-input-group select {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-light);
            padding: 4px 8px;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }

        .style-input-group input:focus,
        .style-input-group select:focus {
            outline: none;
            border-color: var(--primary-glow);
            box-shadow: 0 0 5px var(--primary-glow);
        }

        .style-input-group input[type="range"] {
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: var(--border-color);
            cursor: pointer;
        }

        .style-input-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-glow);
            cursor: pointer;
            border: none;
        }

        .style-input-group input[type="color"] {
            width: 100%;
            height: 30px;
            padding: 2px;
            cursor: pointer;
        }

        .filter-preview {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.7rem;
            color: var(--accent-color);
        }

        /* === LAYERS PANEL === */
        aside.layers {
            grid-area: layers;
            background: var(--panel-bg);
            border-top: 2px solid var(--border-color);
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            color: var(--accent-color);
            user-select: none;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            height: 80px;
        }

        .layers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .layers-header h3 {
            margin: 0;
            color: var(--primary-glow);
            font-size: 1rem;
        }

        .layers-content {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            overflow-x: auto;
            padding: 0.3rem 0;
            flex: 1;
        }

        .layer-item {
            background: transparent;
            border: 2px solid var(--primary-glow);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            min-width: 80px;
            justify-content: center;
            position: relative;
            font-size: 0.8rem;
        }

        .layer-item:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
        }

        .layer-item.selected {
            background: var(--primary-glow);
            color: var(--bg-dark);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .layer-item .layer-icon {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .layer-controls {
            position: absolute;
            top: -5px;
            right: -5px;
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .layer-item:hover .layer-controls {
            opacity: 1;
        }

        .layer-control-btn {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1px solid var(--primary-glow);
            background: var(--panel-bg);
            color: var(--primary-glow);
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .layer-control-btn:hover {
            background: var(--primary-glow);
            color: var(--bg-dark);
        }

        /* === ZOOM CONTROLS === */
        .zoom-controls {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .zoom-controls button {
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1rem;
            line-height: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent;
            border: 2px solid var(--primary-glow);
            color: var(--primary-glow);
            transition: all 0.3s ease;
        }

        .zoom-controls button:hover {
            background: var(--primary-glow);
            color: var(--bg-dark);
            transform: scale(1.05);
        }

        .zoom-level {
            color: var(--accent-color);
            font-weight: 600;
            min-width: 50px;
            text-align: center;
            font-size: 0.8rem;
        }

        /* === LOADING SPINNER === */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            color: var(--primary-glow);
            font-size: 1.2rem;
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .controls-bar {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.5rem;
            }

            .property-line {
                grid-template-columns: 1fr;
                gap: 0.3rem;
            }

            .property-line label {
                text-align: left;
            }

            .layers {
                height: 100px;
            }

            .style-grid {
                grid-template-columns: 1fr;
            }
        }

        /* === ACCESSIBILITY === */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* === COLLABORATION STYLES === */
        .collaboration-panel {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0 0.8rem;
            border-left: 2px solid var(--border-color);
        }

        .online-users {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .user-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-indicator:hover {
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary-glow);
            color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            border: 2px solid var(--primary-glow);
            position: relative;
        }

        .user-indicator.self .user-avatar {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .user-name {
            font-size: 0.6rem;
            color: var(--accent-color);
            font-weight: 600;
            max-width: 50px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-status {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            border: 2px solid var(--panel-bg);
        }

        .collab-btn {
            background: transparent;
            border: 2px solid var(--primary-glow);
            color: var(--primary-glow);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            font-weight: 500;
            position: relative;
        }

        .collab-btn:hover {
            background: var(--primary-glow);
            color: var(--bg-dark);
            transform: translateY(-1px);
        }

        .collab-btn.active {
            background: var(--primary-glow);
            color: var(--bg-dark);
        }

        .message-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.6rem;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s ease-in-out infinite;
        }

        /* === CHAT PANEL === */
        .chat-panel {
            position: fixed;
            right: 20px;
            top: 140px;
            width: 300px;
            height: 400px;
            background: var(--panel-bg);
            border: 2px solid var(--primary-glow);
            border-radius: 12px;
            display: none;
            flex-direction: column;
            z-index: 10000;
            box-shadow: 0 0 30px var(--shadow-glow);
        }

        .chat-panel.show {
            display: flex;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            color: var(--primary-glow);
            font-size: 1rem;
        }

        .chat-close {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-message {
            padding: 0.5rem;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.self {
            background: var(--primary-glow);
            color: var(--bg-dark);
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-message.other {
            background: var(--border-color);
            color: var(--text-light);
            align-self: flex-start;
        }

        .chat-message.system {
            background: rgba(136, 136, 136, 0.2);
            color: var(--accent-color);
            align-self: center;
            font-style: italic;
            font-size: 0.8rem;
            max-width: 90%;
            text-align: center;
        }

        .chat-message .sender {
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
            opacity: 0.8;
        }

        .chat-message .content {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .chat-message .timestamp {
            font-size: 0.6rem;
            opacity: 0.6;
            margin-top: 0.2rem;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 2px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-light);
            padding: 8px 12px;
            font-family: var(--font-family);
            font-size: 0.8rem;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-glow);
            box-shadow: 0 0 8px var(--primary-glow);
        }

        .chat-send {
            background: var(--primary-glow);
            border: none;
            color: var(--bg-dark);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .chat-send:hover {
            transform: translateY(-1px);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        /* === INVITE MODAL === */
        .invite-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .invite-modal-content {
            background: var(--panel-bg);
            margin: 15% auto;
            padding: 2rem;
            border: 2px solid var(--primary-glow);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px var(--primary-glow);
            animation: modalSlideIn 0.3s ease-out;
        }

        .invite-link {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            color: var(--text-light);
            font-family: monospace;
            font-size: 0.9rem;
            width: 100%;
            margin: 1rem 0;
            word-break: break-all;
        }

        .invite-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        /* === COLLABORATION STATUS === */
        .collaboration-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--panel-bg);
            border: 2px solid var(--success-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: var(--success-color);
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            display: none;
        }

        .collaboration-status.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- TOP BAR -->
    <header>
        <div class="title">
            <div class="logo-text">editIQ</div>
            <button class="version-switcher" id="version-switcher" title="Switch Theme">
                <span>üîÅ</span>
                <span class="version-text">v0.1</span>
            </button>
        </div>
        <button id="btn-export" title="Export Project">üì§ Export</button>
        <div class="user-profile" id="user-profile">
            <span>üë§ User</span>
            <span class="beta-badge">BETA</span>
            <div class="profile-dropdown" id="profile-dropdown">
                <h3 style="margin-top: 0; color: var(--primary-glow);">Beta Profile</h3>
                <p style="margin: 0.5rem 0; color: var(--accent-color);">‚ú® Unlimited Projects</p>
                <p style="margin: 0.5rem 0; color: var(--accent-color);">üöÄ Unlimited Exports</p>
                <p style="margin: 0.5rem 0; color: var(--accent-color);">üé® All Themes</p>
                <p style="margin: 0.5rem 0; color: var(--accent-color);">‚ö° Priority Support</p>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <small style="color: var(--text-light); opacity: 0.7;">Beta Version - All features unlocked</small>
                </div>
            </div>
        </div>
        <div class="collaboration-panel" id="collaboration-panel">
            <div class="online-users" id="online-users">
                <div class="user-indicator self" title="You">
                    <div class="user-avatar">üë§</div>
                    <span class="user-name">You</span>
                </div>
            </div>
            <button class="collab-btn" id="invite-btn" title="Invite Users">üë• Invite</button>
            <button class="collab-btn" id="chat-toggle" title="Toggle Chat">üí¨</button>
        </div>
    </header>

    <!-- CONTROLS BAR -->
    <div class="controls-bar">
        <button class="control-btn" id="add-image" title="Add Image">üñºÔ∏è Image</button>
        <input type="file" id="file-image" accept="image/*" style="display:none" />
        
        <button class="control-btn" id="add-video" title="Add Video (Beta)" disabled>üé¨ Video</button>
        <input type="file" id="file-video" accept="video/*" style="display:none" />
        
        <button class="control-btn" id="add-text" title="Add Text">üìù Text</button>
        <button class="control-btn" id="add-shape" title="Add Circle">‚≠ï Circle</button>
        <button class="control-btn" id="add-rectangle" title="Add Rectangle">‚¨ú Rectangle</button>
        <button class="control-btn" id="add-cube" title="Add 3D Cube">üßä Cube</button>
        
        <button class="control-btn" id="btn-more" title="More Tools (Beta)" disabled>‚öôÔ∏è More</button>
        
        <select class="preset-selector" id="canvas-preset" title="Canvas Presets">
            <option value="">üìê Canvas Presets</option>
            <optgroup label="üì∫ Video Platforms">
                <option value="youtube-thumbnail">YouTube Thumbnail (1280√ó720)</option>
                <option value="youtube-banner">YouTube Banner (2560√ó1440)</option>
                <option value="youtube-shorts">YouTube Shorts (1080√ó1920)</option>
                <option value="tiktok-video">TikTok Video (1080√ó1920)</option>
                <option value="tiktok-profile">TikTok Profile (200√ó200)</option>
            </optgroup>
            <optgroup label="üì∑ Instagram">
                <option value="instagram-post">Instagram Post (1080√ó1080)</option>
                <option value="instagram-story">Instagram Story (1080√ó1920)</option>
                <option value="instagram-reel">Instagram Reel (1080√ó1920)</option>
                <option value="instagram-profile">Instagram Profile (320√ó320)</option>
                <option value="instagram-highlight">Instagram Highlight (1080√ó1920)</option>
            </optgroup>
            <optgroup label="üë• Facebook">
                <option value="facebook-post">Facebook Post (1200√ó630)</option>
                <option value="facebook-cover">Facebook Cover (1640√ó859)</option>
                <option value="facebook-profile">Facebook Profile (170√ó170)</option>
                <option value="facebook-event">Facebook Event (1920√ó1080)</option>
                <option value="facebook-ad">Facebook Ad (1200√ó628)</option>
            </optgroup>
            <optgroup label="üê¶ Twitter/X">
                <option value="twitter-post">Twitter Post (1200√ó675)</option>
                <option value="twitter-header">Twitter Header (1500√ó500)</option>
                <option value="twitter-profile">Twitter Profile (400√ó400)</option>
                <option value="twitter-card">Twitter Card (1200√ó628)</option>
            </optgroup>
            <optgroup label="üíº LinkedIn">
                <option value="linkedin-post">LinkedIn Post (1200√ó627)</option>
                <option value="linkedin-cover">LinkedIn Cover (1584√ó396)</option>
                <option value="linkedin-profile">LinkedIn Profile (400√ó400)</option>
                <option value="linkedin-company">LinkedIn Company (1536√ó768)</option>
            </optgroup>
            <optgroup label="üìå Pinterest">
                <option value="pinterest-pin">Pinterest Pin (1000√ó1500)</option>
                <option value="pinterest-board">Pinterest Board (222√ó150)</option>
                <option value="pinterest-profile">Pinterest Profile (165√ó165)</option>
            </optgroup>
            <optgroup label="üëª Snapchat">
                <option value="snapchat-ad">Snapchat Ad (1080√ó1920)</option>
                <option value="snapchat-geofilter">Snapchat Geofilter (1080√ó1920)</option>
            </optgroup>
            <optgroup label="üéµ Music Platforms">
                <option value="spotify-cover">Spotify Cover (640√ó640)</option>
                <option value="soundcloud-cover">SoundCloud Cover (800√ó800)</option>
                <option value="apple-music">Apple Music Cover (1400√ó1400)</option>
            </optgroup>
            <optgroup label="üñ•Ô∏è Desktop & Web">
                <option value="desktop-wallpaper">Desktop Wallpaper (1920√ó1080)</option>
                <option value="desktop-4k">Desktop 4K (3840√ó2160)</option>
                <option value="web-banner">Web Banner (728√ó90)</option>
                <option value="web-header">Web Header (1920√ó400)</option>
            </optgroup>
            <optgroup label="üì± Mobile">
                <option value="mobile-wallpaper">Mobile Wallpaper (1080√ó1920)</option>
                <option value="iphone-wallpaper">iPhone Wallpaper (1170√ó2532)</option>
                <option value="android-wallpaper">Android Wallpaper (1080√ó1920)</option>
            </optgroup>
            <optgroup label="üìÑ Print & Documents">
                <option value="a4-portrait">A4 Portrait (2480√ó3508)</option>
                <option value="a4-landscape">A4 Landscape (3508√ó2480)</option>
                <option value="business-card">Business Card (1050√ó600)</option>
                <option value="poster-small">Small Poster (2480√ó3508)</option>
                <option value="poster-large">Large Poster (4961√ó7016)</option>
            </optgroup>
        </select>
        
        <button class="control-btn" id="btn-undo" title="Undo (Ctrl+Z)">‚Ü∂ Undo</button>
        <button class="control-btn" id="btn-redo" title="Redo (Ctrl+Y)">‚Ü∑ Redo</button>
        <button class="control-btn" id="btn-new" title="New Project">üóé New</button>
        <button class="control-btn" id="btn-save" title="Save Project">üíæ Save</button>
        
        <!-- STYLING CONTROLS -->
        <div style="border-left: 2px solid var(--border-color); padding-left: 0.6rem; margin-left: 0.6rem;">
            <button class="control-btn" id="basic-styling" title="Basic Styling">üé® Basic</button>
            <button class="control-btn" id="advanced-styling" title="Advanced Styling">‚öôÔ∏è Advanced</button>
        </div>
    </div>

    <!-- EXPORT MODAL -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-modal">&times;</span>
            <h2>Export Settings</h2>
            <div class="export-options">
                <div class="export-row">
                    <div class="export-group">
                        <label for="export-format">Format</label>
                        <select id="export-format">
                            <option value="png">PNG</option>
                            <option value="jpg">JPEG</option>
                            <option value="webp">WebP</option>
                            <option value="mp4" disabled>MP4 (Coming Soon)</option>
                            <option value="gif" disabled>GIF (Coming Soon)</option>
                        </select>
                    </div>
                    <div class="export-group">
                        <label for="export-quality">Quality</label>
                        <select id="export-quality">
                            <option value="1">Standard (1x)</option>
                            <option value="2">High (2x)</option>
                            <option value="3">Ultra (3x)</option>
                            <option value="4">Maximum (4x)</option>
                        </select>
                    </div>
                </div>
                <div class="export-row">
                    <div class="export-group">
                        <label for="export-width">Width (px)</label>
                        <input type="number" id="export-width" min="100" max="8000" value="1080">
                    </div>
                    <div class="export-group">
                        <label for="export-height">Height (px)</label>
                        <input type="number" id="export-height" min="100" max="8000" value="1080">
                    </div>
                </div>
                <div class="export-group">
                    <label for="export-filename">Filename</label>
                    <input type="text" id="export-filename" value="editIQ-export" placeholder="Enter filename">
                </div>
            </div>
            <div class="export-buttons">
                <button class="export-btn cancel" id="cancel-export">Cancel</button>
                <button class="export-btn" id="confirm-export">Export</button>
            </div>
        </div>
    </div>

    <!-- MAIN CANVAS -->
    <main class="canvas" tabindex="0" aria-label="Editing Canvas">
        <div class="canvas-container">
            <div class="canvas-inner" id="canvas-inner">
                <div class="canvas-info">
                    <span id="canvas-size-display">1080 √ó 1080 (1:1)</span>
                    <span id="canvas-zoom-display">100%</span>
                </div>
                <div class="canvas-ratio-indicator" id="canvas-ratio-indicator">1:1</div>
                <canvas id="glcanvas"></canvas>
            </div>
        </div>
    </main>

    <!-- PROPERTIES PANEL -->
    <aside class="properties" aria-label="Properties Panel">
        <h2>Canvas Settings</h2>
        <div class="property-line">
            <label for="canvas-width">Width</label>
            <input type="number" id="canvas-width" min="100" max="8000" value="1080" />
        </div>
        <div class="property-line">
            <label for="canvas-height">Height</label>
            <input type="number" id="canvas-height" min="100" max="8000" value="1080" />
        </div>
        <div class="property-line">
            <label for="canvas-background">Background</label>
            <input type="color" id="canvas-background" value="#14141a" />
        </div>
        <div class="property-buttons">
            <button class="property-btn" id="center-content">Center All</button>
            <button class="property-btn" id="fit-content">Fit Content</button>
        </div>

        <h2>Element Properties</h2>
        <div class="property-line">
            <label for="prop-name">Name</label>
            <input type="text" id="prop-name" placeholder="Element name" />
        </div>
        <div class="property-line">
            <label for="prop-x">X Position</label>
            <input type="range" id="prop-x" min="-5" max="5" step="0.01" value="0" />
        </div>
        <div class="property-line">
            <label for="prop-y">Y Position</label>
            <input type="range" id="prop-y" min="-5" max="5" step="0.01" value="0" />
        </div>
        <div class="property-line">
            <label for="prop-z">Z Position</label>
            <input type="range" id="prop-z" min="-5" max="5" step="0.01" value="0" />
        </div>
        <div class="property-line">
            <label for="prop-rotate-x">Rotate X</label>
            <input type="range" id="prop-rotate-x" min="-180" max="180" step="1" value="0" />
        </div>
        <div class="property-line">
            <label for="prop-rotate-y">Rotate Y</label>
            <input type="range" id="prop-rotate-y" min="-180" max="180" step="1" value="0" />
        </div>
        <div class="property-line">
            <label for="prop-rotate-z">Rotate Z</label>
            <input type="range" id="prop-rotate-z" min="-180" max="180" step="1" value="0" />
        </div>
        <div class="property-line">
            <label for="prop-scale">Scale</label>
            <input type="range" id="prop-scale" min="0.1" max="3" step="0.01" value="1" />
        </div>
        <div class="property-line">
            <label for="prop-opacity">Opacity</label>
            <input type="range" id="prop-opacity" min="0" max="100" step="1" value="100" />
        </div>

        <div class="property-line" id="text-content-line" style="display: none;">
            <label for="prop-text">Text</label>
            <input type="text" id="prop-text" />
        </div>
        <div class="property-line" id="text-size-line" style="display: none;">
            <label for="prop-text-size">Font Size</label>
            <input type="range" id="prop-text-size" min="10" max="100" step="1" value="32" />
        </div>
        <div class="property-line" id="text-weight-line" style="display: none;">
            <label for="prop-text-weight">Font Weight</label>
            <select id="prop-text-weight">
                <option value="normal">Normal</option>
                <option value="bold">Bold</option>
                <option value="lighter">Light</option>
            </select>
        </div>
        <div class="property-line" id="main-color-line" style="display: none;">
            <label for="prop-main-color">Color</label>
            <input type="color" id="prop-main-color" value="#00ffff" />
        </div>
        <div class="property-line" id="bg-color-line" style="display: none;">
            <label for="prop-bg-color">Background</label>
            <input type="color" id="prop-bg-color" value="#000000" />
        </div>
        <div class="property-line" id="border-color-line" style="display: none;">
            <label for="prop-border-color">Border Color</label>
            <input type="color" id="prop-border-color" value="#ff0000" />
        </div>
        <div class="property-line" id="border-width-line" style="display: none;">
            <label for="prop-border-width">Border Width</label>
            <input type="range" id="prop-border-width" min="0" max="20" step="1" value="2" />
        </div>
        <div class="property-line" id="border-radius-line" style="display: none;">
            <label for="prop-border-radius">Border Radius</label>
            <input type="range" id="prop-border-radius" min="0" max="50" step="1" value="10" />
        </div>
        <div class="property-line" id="image-brightness-line" style="display: none;">
            <label for="prop-image-brightness">Brightness</label>
            <input type="range" id="prop-image-brightness" min="0" max="200" step="1" value="100" />
        </div>
        <div class="property-line" id="image-contrast-line" style="display: none;">
            <label for="prop-image-contrast">Contrast</label>
            <input type="range" id="prop-image-contrast" min="0" max="200" step="1" value="100" />
        </div>
        <div class="property-line" id="image-saturation-line" style="display: none;">
            <label for="prop-image-saturation">Saturation</label>
            <input type="range" id="prop-image-saturation" min="0" max="200" step="1" value="100" />
        </div>

        <!-- ADVANCED STYLING PANEL -->
        <div class="advanced-styling" id="advanced-styling-panel">
            <h3>
                üé® Advanced Styling 
                <span class="beta-tag">BETA</span>
                <span class="free-tag">FREE</span>
                <span class="unlimited-tag">UNLIMITED</span>
            </h3>

            <!-- BORDERS SECTION -->
            <div class="style-section">
                <h4>üî≤ Borders</h4>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Border Style</label>
                        <select id="adv-border-style">
                            <option value="none">None</option>
                            <option value="solid">Solid</option>
                            <option value="dotted">Dotted</option>
                            <option value="dashed">Dashed</option>
                            <option value="double">Double</option>
                            <option value="groove">Groove</option>
                            <option value="ridge">Ridge</option>
                            <option value="inset">Inset</option>
                            <option value="outset">Outset</option>
                        </select>
                    </div>
                    <div class="style-input-group">
                        <label>Border Width</label>
                        <input type="range" id="adv-border-width" min="0" max="20" value="1" />
                    </div>
                    <div class="style-input-group">
                        <label>Border Color</label>
                        <input type="color" id="adv-border-color" value="#000000" />
                    </div>
                    <div class="style-input-group">
                        <label>Border Radius</label>
                        <input type="range" id="adv-border-radius" min="0" max="50" value="0" />
                    </div>
                </div>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Top Left Radius</label>
                        <input type="range" id="adv-border-top-left" min="0" max="50" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Top Right Radius</label>
                        <input type="range" id="adv-border-top-right" min="0" max="50" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Bottom Left Radius</label>
                        <input type="range" id="adv-border-bottom-left" min="0" max="50" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Bottom Right Radius</label>
                        <input type="range" id="adv-border-bottom-right" min="0" max="50" value="0" />
                    </div>
                </div>
            </div>

            <!-- BOX SHADOW SECTION -->
            <div class="style-section">
                <h4>üåü Box Shadow</h4>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Offset X</label>
                        <input type="range" id="adv-shadow-x" min="-20" max="20" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Offset Y</label>
                        <input type="range" id="adv-shadow-y" min="-20" max="20" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Blur Radius</label>
                        <input type="range" id="adv-shadow-blur" min="0" max="50" value="5" />
                    </div>
                    <div class="style-input-group">
                        <label>Spread Radius</label>
                        <input type="range" id="adv-shadow-spread" min="-20" max="20" value="0" />
                    </div>
                </div>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Shadow Color</label>
                        <input type="color" id="adv-shadow-color" value="#000000" />
                    </div>
                    <div class="style-input-group">
                        <label>Shadow Opacity</label>
                        <input type="range" id="adv-shadow-opacity" min="0" max="100" value="50" />
                    </div>
                </div>
            </div>

            <!-- BACKGROUND SECTION -->
            <div class="style-section">
                <h4>üé® Background</h4>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Background Type</label>
                        <select id="adv-bg-type">
                            <option value="color">Solid Color</option>
                            <option value="gradient">Linear Gradient</option>
                            <option value="radial">Radial Gradient</option>
                            <option value="image">Image</option>
                        </select>
                    </div>
                    <div class="style-input-group">
                        <label>Primary Color</label>
                        <input type="color" id="adv-bg-color1" value="#ffffff" />
                    </div>
                    <div class="style-input-group">
                        <label>Secondary Color</label>
                        <input type="color" id="adv-bg-color2" value="#000000" />
                    </div>
                    <div class="style-input-group">
                        <label>Gradient Angle</label>
                        <input type="range" id="adv-bg-angle" min="0" max="360" value="45" />
                    </div>
                </div>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Background Size</label>
                        <select id="adv-bg-size">
                            <option value="auto">Auto</option>
                            <option value="cover">Cover</option>
                            <option value="contain">Contain</option>
                            <option value="100% 100%">Stretch</option>
                        </select>
                    </div>
                    <div class="style-input-group">
                        <label>Background Position</label>
                        <select id="adv-bg-position">
                            <option value="center">Center</option>
                            <option value="top">Top</option>
                            <option value="bottom">Bottom</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                            <option value="top left">Top Left</option>
                            <option value="top right">Top Right</option>
                            <option value="bottom left">Bottom Left</option>
                            <option value="bottom right">Bottom Right</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- TRANSFORM & ANIMATION SECTION -->
            <div class="style-section">
                <h4>üîÑ Transform & Animation</h4>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Translate X</label>
                        <input type="range" id="adv-translate-x" min="-100" max="100" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Translate Y</label>
                        <input type="range" id="adv-translate-y" min="-100" max="100" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Scale X</label>
                        <input type="range" id="adv-scale-x" min="0.1" max="3" step="0.1" value="1" />
                    </div>
                    <div class="style-input-group">
                        <label>Scale Y</label>
                        <input type="range" id="adv-scale-y" min="0.1" max="3" step="0.1" value="1" />
                    </div>
                </div>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Skew X</label>
                        <input type="range" id="adv-skew-x" min="-45" max="45" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Skew Y</label>
                        <input type="range" id="adv-skew-y" min="-45" max="45" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Transition Duration</label>
                        <input type="range" id="adv-transition-duration" min="0" max="5" step="0.1" value="0.3" />
                    </div>
                    <div class="style-input-group">
                        <label>Transition Timing</label>
                        <select id="adv-transition-timing">
                            <option value="ease">Ease</option>
                            <option value="ease-in">Ease In</option>
                            <option value="ease-out">Ease Out</option>
                            <option value="ease-in-out">Ease In Out</option>
                            <option value="linear">Linear</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- TEXT-ONLY STYLES -->
            <div class="style-section" id="text-advanced-styles" style="display: none;">
                <h4>üìù Advanced Text Styles</h4>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Font Family</label>
                        <select id="adv-font-family">
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Impact">Impact</option>
                            <option value="Comic Sans MS">Comic Sans MS</option>
                            <option value="Trebuchet MS">Trebuchet MS</option>
                            <option value="Orbitron">Orbitron</option>
                        </select>
                    </div>
                    <div class="style-input-group">
                        <label>Text Align</label>
                        <select id="adv-text-align">
                            <option value="left">Left</option>
                            <option value="center">Center</option>
                            <option value="right">Right</option>
                            <option value="justify">Justify</option>
                        </select>
                    </div>
                    <div class="style-input-group">
                        <label>Text Transform</label>
                        <select id="adv-text-transform">
                            <option value="none">None</option>
                            <option value="uppercase">Uppercase</option>
                            <option value="lowercase">Lowercase</option>
                            <option value="capitalize">Capitalize</option>
                        </select>
                    </div>
                    <div class="style-input-group">
                        <label>Text Decoration</label>
                        <select id="adv-text-decoration">
                            <option value="none">None</option>
                            <option value="underline">Underline</option>
                            <option value="overline">Overline</option>
                            <option value="line-through">Line Through</option>
                        </select>
                    </div>
                </div>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Letter Spacing</label>
                        <input type="range" id="adv-letter-spacing" min="-5" max="10" step="0.1" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Line Height</label>
                        <input type="range" id="adv-line-height" min="0.5" max="3" step="0.1" value="1.2" />
                    </div>
                    <div class="style-input-group">
                        <label>Text Shadow X</label>
                        <input type="range" id="adv-text-shadow-x" min="-10" max="10" value="2" />
                    </div>
                    <div class="style-input-group">
                        <label>Text Shadow Y</label>
                        <input type="range" id="adv-text-shadow-y" min="-10" max="10" value="2" />
                    </div>
                </div>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Text Shadow Blur</label>
                        <input type="range" id="adv-text-shadow-blur" min="0" max="20" value="4" />
                    </div>
                    <div class="style-input-group">
                        <label>Text Shadow Color</label>
                        <input type="color" id="adv-text-shadow-color" value="#000000" />
                    </div>
                </div>
            </div>

            <!-- IMAGE-ONLY STYLES -->
            <div class="style-section" id="image-advanced-styles" style="display: none;">
                <h4>üñºÔ∏è Advanced Image Styles</h4>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Object Fit</label>
                        <select id="adv-object-fit">
                            <option value="fill">Fill</option>
                            <option value="contain">Contain</option>
                            <option value="cover">Cover</option>
                            <option value="none">None</option>
                            <option value="scale-down">Scale Down</option>
                        </select>
                    </div>
                    <div class="style-input-group">
                        <label>Object Position</label>
                        <select id="adv-object-position">
                            <option value="center">Center</option>
                            <option value="top">Top</option>
                            <option value="bottom">Bottom</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                            <option value="top left">Top Left</option>
                            <option value="top right">Top Right</option>
                            <option value="bottom left">Bottom Left</option>
                            <option value="bottom right">Bottom Right</option>
                        </select>
                    </div>
                    <div class="style-input-group">
                        <label>Image Rendering</label>
                        <select id="adv-image-rendering">
                            <option value="auto">Auto</option>
                            <option value="crisp-edges">Crisp Edges</option>
                            <option value="pixelated">Pixelated</option>
                        </select>
                    </div>
                    <div class="style-input-group">
                        <label>Mix Blend Mode</label>
                        <select id="adv-mix-blend-mode">
                            <option value="normal">Normal</option>
                            <option value="multiply">Multiply</option>
                            <option value="screen">Screen</option>
                            <option value="overlay">Overlay</option>
                            <option value="darken">Darken</option>
                            <option value="lighten">Lighten</option>
                            <option value="color-dodge">Color Dodge</option>
                            <option value="color-burn">Color Burn</option>
                            <option value="hard-light">Hard Light</option>
                            <option value="soft-light">Soft Light</option>
                            <option value="difference">Difference</option>
                            <option value="exclusion">Exclusion</option>
                        </select>
                    </div>
                </div>
                <div class="style-grid">
                    <div class="style-input-group">
                        <label>Blur</label>
                        <input type="range" id="adv-filter-blur" min="0" max="20" step="0.1" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Hue Rotate</label>
                        <input type="range" id="adv-filter-hue" min="0" max="360" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Invert</label>
                        <input type="range" id="adv-filter-invert" min="0" max="100" value="0" />
                    </div>
                    <div class="style-input-group">
                        <label>Sepia</label>
                        <input type="range" id="adv-filter-sepia" min="0" max="100" value="0" />
                    </div>
                </div>
            </div>

            <!-- FILTER PREVIEW -->
            <div class="filter-preview" id="filter-preview">
                CSS Preview: No filters applied
            </div>

            <div class="property-buttons" style="margin-top: 1rem;">
                <button class="property-btn" id="apply-advanced-styles">Apply Styles</button>
                <button class="property-btn" id="reset-advanced-styles">Reset All</button>
            </div>
        </div>

        <h2>3D Presets</h2>
        <div class="property-buttons">
            <button class="property-btn" id="preset-flip">Flip Card</button>
            <button class="property-btn" id="preset-cube">Cube Spin</button>
            <button class="property-btn" id="preset-float">Float 3D</button>
            <button class="property-btn" id="preset-reset">Reset 3D</button>
        </div>

        <h2>Layer Controls</h2>
        <div class="property-buttons">
            <button class="property-btn" id="layer-up">Move Up</button>
            <button class="property-btn" id="layer-down">Move Down</button>
            <button class="property-btn" id="layer-duplicate">Duplicate</button>
            <button class="property-btn" id="layer-delete">Delete</button>
        </div>
    </aside>

    <!-- LAYERS PANEL -->
    <aside class="layers" aria-label="Layers Panel">
        <div class="layers-header">
            <h3>Layers</h3>
            <div class="zoom-controls">
                <button id="zoom-out" title="Zoom Out">‚àí</button>
                <div class="zoom-level" id="zoom-level">100%</div>
                <button id="zoom-in" title="Zoom In">+</button>
                <button id="zoom-reset" title="Reset Zoom">‚åÇ</button>
            </div>
        </div>
        <div class="layers-content" id="layers-content">
            <!-- Layers will be dynamically added here -->
        </div>
    </aside>

    <!-- LOADING INDICATOR -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Processing...</div>
    </div>

    <!-- CHAT PANEL -->
    <div class="chat-panel" id="chat-panel">
        <div class="chat-header">
            <h3>üí¨ Team Chat</h3>
            <button class="chat-close" id="chat-close">√ó</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be added here dynamically -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." maxlength="500">
            <button class="chat-send" id="chat-send">Send</button>
        </div>
    </div>

    <!-- INVITE MODAL -->
    <div id="invite-modal" class="invite-modal">
        <div class="invite-modal-content">
            <span class="close" id="close-invite-modal">&times;</span>
            <h2>Invite Collaborators</h2>
            <p>Share this link to invite others to collaborate:</p>
            <input type="text" class="invite-link" id="invite-link" readonly>
            <div class="invite-buttons">
                <button class="export-btn" id="copy-invite-link">üìã Copy Link</button>
                <button class="export-btn cancel" id="close-invite">Close</button>
            </div>
        </div>
    </div>

    <!-- COLLABORATION STATUS -->
    <div class="collaboration-status" id="collaboration-status">
        üü¢ Connected to collaboration server
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script>
        // === THREE.JS GLOBALS ===
        let scene, camera, renderer, selected = null;
        const objects = [];
        let elementCounter = 0;
        let history = [];
        let historyIndex = -1;

        // === UI GLOBALS ===
        const canvas = document.getElementById('glcanvas');
        const canvasInner = document.getElementById('canvas-inner');
        const addTextBtn = document.getElementById('add-text');
        const addShapeBtn = document.getElementById('add-shape');
        const addImageBtn = document.getElementById('add-image');
        const addVideoBtn = document.getElementById('add-video');
        const addRectangleBtn = document.getElementById('add-rectangle');
        const addCubeBtn = document.getElementById('add-cube');
        const fileImageInput = document.getElementById('file-image');
        const fileVideoInput = document.getElementById('file-video');

        // Canvas ratio management
        let currentCanvasWidth = 1080;
        let currentCanvasHeight = 1080;
        let canvasScale = 1;

        // Styling mode
        let isAdvancedStylingMode = false;
        let currentAdvancedStyles = {};

        const canvasPresets = {
            // Video Platforms
            'youtube-thumbnail': { width: 1280, height: 720, name: 'YouTube Thumbnail' },
            'youtube-banner': { width: 2560, height: 1440, name: 'YouTube Banner' },
            'youtube-shorts': { width: 1080, height: 1920, name: 'YouTube Shorts' },
            'tiktok-video': { width: 1080, height: 1920, name: 'TikTok Video' },
            'tiktok-profile': { width: 200, height: 200, name: 'TikTok Profile' },
            
            // Instagram
            'instagram-post': { width: 1080, height: 1080, name: 'Instagram Post' },
            'instagram-story': { width: 1080, height: 1920, name: 'Instagram Story' },
            'instagram-reel': { width: 1080, height: 1920, name: 'Instagram Reel' },
            'instagram-profile': { width: 320, height: 320, name: 'Instagram Profile' },
            'instagram-highlight': { width: 1080, height: 1920, name: 'Instagram Highlight' },
            
            // Facebook
            'facebook-post': { width: 1200, height: 630, name: 'Facebook Post' },
            'facebook-cover': { width: 1640, height: 859, name: 'Facebook Cover' },
            'facebook-profile': { width: 170, height: 170, name: 'Facebook Profile' },
            'facebook-event': { width: 1920, height: 1080, name: 'Facebook Event' },
            'facebook-ad': { width: 1200, height: 628, name: 'Facebook Ad' },
            
            // Twitter/X
            'twitter-post': { width: 1200, height: 675, name: 'Twitter Post' },
            'twitter-header': { width: 1500, height: 500, name: 'Twitter Header' },
            'twitter-profile': { width: 400, height: 400, name: 'Twitter Profile' },
            'twitter-card': { width: 1200, height: 628, name: 'Twitter Card' },
            
            // LinkedIn
            'linkedin-post': { width: 1200, height: 627, name: 'LinkedIn Post' },
            'linkedin-cover': { width: 1584, height: 396, name: 'LinkedIn Cover' },
            'linkedin-profile': { width: 400, height: 400, name: 'LinkedIn Profile' },
            'linkedin-company': { width: 1536, height: 768, name: 'LinkedIn Company' },
            
            // Pinterest
            'pinterest-pin': { width: 1000, height: 1500, name: 'Pinterest Pin' },
            'pinterest-board': { width: 222, height: 150, name: 'Pinterest Board' },
            'pinterest-profile': { width: 165, height: 165, name: 'Pinterest Profile' },
            
            // Snapchat
            'snapchat-ad': { width: 1080, height: 1920, name: 'Snapchat Ad' },
            'snapchat-geofilter': { width: 1080, height: 1920, name: 'Snapchat Geofilter' },
            
            // Music Platforms
            'spotify-cover': { width: 640, height: 640, name: 'Spotify Cover' },
            'soundcloud-cover': { width: 800, height: 800, name: 'SoundCloud Cover' },
            'apple-music': { width: 1400, height: 1400, name: 'Apple Music Cover' },
            
            // Desktop & Web
            'desktop-wallpaper': { width: 1920, height: 1080, name: 'Desktop Wallpaper' },
            'desktop-4k': { width: 3840, height: 2160, name: 'Desktop 4K' },
            'web-banner': { width: 728, height: 90, name: 'Web Banner' },
            'web-header': { width: 1920, height: 400, name: 'Web Header' },
            
            // Mobile
            'mobile-wallpaper': { width: 1080, height: 1920, name: 'Mobile Wallpaper' },
            'iphone-wallpaper': { width: 1170, height: 2532, name: 'iPhone Wallpaper' },
            'android-wallpaper': { width: 1080, height: 1920, name: 'Android Wallpaper' },
            
            // Print & Documents
            'a4-portrait': { width: 2480, height: 3508, name: 'A4 Portrait' },
            'a4-landscape': { width: 3508, height: 2480, name: 'A4 Landscape' },
            'business-card': { width: 1050, height: 600, name: 'Business Card' },
            'poster-small': { width: 2480, height: 3508, name: 'Small Poster' },
            'poster-large': { width: 4961, height: 7016, name: 'Large Poster' }
        };

        // Theme management
        const themes = ['default', 'purple', 'red', 'green'];
        const modes = ['dark', 'light'];
        let currentThemeIndex = 0;
        let currentModeIndex = 0;

        // UI elements for canvas controls
        const canvasPresetSelector = document.getElementById('canvas-preset');
        const canvasWidthInput = document.getElementById('canvas-width');
        const canvasHeightInput = document.getElementById('canvas-height');
        const canvasBackgroundInput = document.getElementById('canvas-background');
        const canvasSizeDisplay = document.getElementById('canvas-size-display');
        const canvasZoomDisplay = document.getElementById('canvas-zoom-display');
        const canvasRatioIndicator = document.getElementById('canvas-ratio-indicator');

        // Export modal elements
        const exportModal = document.getElementById('export-modal');
        const exportBtn = document.getElementById('btn-export');
        const closeModal = document.getElementById('close-modal');
        const cancelExport = document.getElementById('cancel-export');
        const confirmExport = document.getElementById('confirm-export');
        const exportFormat = document.getElementById('export-format');
        const exportQuality = document.getElementById('export-quality');
        const exportWidth = document.getElementById('export-width');
        const exportHeight = document.getElementById('export-height');
        const exportFilename = document.getElementById('export-filename');

        // User profile
        const userProfile = document.getElementById('user-profile');
        const profileDropdown = document.getElementById('profile-dropdown');

        // Version switcher
        const versionSwitcher = document.getElementById('version-switcher');

        // Property controls
        const propName = document.getElementById('prop-name');
        const propX = document.getElementById('prop-x');
        const propY = document.getElementById('prop-y');
        const propZ = document.getElementById('prop-z');
        const propText = document.getElementById('prop-text');
        const propTextSize = document.getElementById('prop-text-size');
        const propTextWeight = document.getElementById('prop-text-weight');
        const propRotateX = document.getElementById('prop-rotate-x');
        const propRotateY = document.getElementById('prop-rotate-y');
        const propRotateZ = document.getElementById('prop-rotate-z');
        const propScale = document.getElementById('prop-scale');
        const propOpacity = document.getElementById('prop-opacity');
        const propMainColor = document.getElementById('prop-main-color');
        const propBgColor = document.getElementById('prop-bg-color');
        const propBorderColor = document.getElementById('prop-border-color');
        const propBorderWidth = document.getElementById('prop-border-width');
        const propBorderRadius = document.getElementById('prop-border-radius');
        const propImageBrightness = document.getElementById('prop-image-brightness');
        const propImageContrast = document.getElementById('prop-image-contrast');
        const propImageSaturation = document.getElementById('prop-image-saturation');

        // UI elements
        const layersContent = document.getElementById('layers-content');
        const zoomLevel = document.getElementById('zoom-level');
        const loading = document.getElementById('loading');

        // === INITIALIZATION ===
        init();
        animate();

        function init() {
            // Setup Three.js renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                preserveDrawingBuffer: true, 
                antialias: true 
            });
            renderer.setClearColor(0x14141a);

            // Setup scene and camera
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, 1, 0.1, 1000);
            camera.position.z = 3;

            // Event listeners
            canvas.addEventListener('mousedown', onCanvasClick);
            window.addEventListener('resize', onWindowResize);

            // Initialize canvas size
            updateCanvasSize(currentCanvasWidth, currentCanvasHeight);

            // Initialize first state
            saveState();
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            updateCanvasSize(currentCanvasWidth, currentCanvasHeight);
        }

        function onCanvasClick(e) {
            const rect = renderer.domElement.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            const mouse = new THREE.Vector2(x, y);
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objects);

            if (intersects.length > 0) {
                selectElement(intersects[0].object);
            } else {
                selectElement(null);
            }
        }

        // === THEME SWITCHING ===
        function switchTheme() {
            // Cycle through themes first
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            
            // If we've cycled through all themes, switch mode
            if (currentThemeIndex === 0) {
                currentModeIndex = (currentModeIndex + 1) % modes.length;
            }

            // Apply theme
            document.body.classList.remove('theme-purple', 'theme-red', 'theme-green', 'light-mode');
            
            if (modes[currentModeIndex] === 'light') {
                document.body.classList.add('light-mode');
            }
            
            if (themes[currentThemeIndex] !== 'default') {
                document.body.classList.add('theme-' + themes[currentThemeIndex]);
            }
        }

        // === STYLING MODE MANAGEMENT ===
        function toggleBasicStyling() {
            isAdvancedStylingMode = false;
            document.getElementById('basic-styling').classList.add('active');
            document.getElementById('advanced-styling').classList.remove('active');
            document.getElementById('advanced-styling-panel').classList.remove('show');
        }

        function toggleAdvancedStyling() {
            isAdvancedStylingMode = true;
            document.getElementById('advanced-styling').classList.add('active');
            document.getElementById('basic-styling').classList.remove('active');
            document.getElementById('advanced-styling-panel').classList.add('show');
            updateAdvancedStylingVisibility();
        }

        function updateAdvancedStylingVisibility() {
            const textAdvanced = document.getElementById('text-advanced-styles');
            const imageAdvanced = document.getElementById('image-advanced-styles');
            
            if (selected) {
                if (selected.userData.type === 'text') {
                    textAdvanced.style.display = 'block';
                    imageAdvanced.style.display = 'none';
                } else if (selected.userData.type === 'image') {
                    textAdvanced.style.display = 'none';
                    imageAdvanced.style.display = 'block';
                } else {
                    textAdvanced.style.display = 'none';
                    imageAdvanced.style.display = 'none';
                }
            } else {
                textAdvanced.style.display = 'none';
                imageAdvanced.style.display = 'none';
            }
        }

        function updateFilterPreview() {
            const preview = document.getElementById('filter-preview');
            let cssText = 'CSS Preview: ';
            
            if (selected && selected.userData.advancedStyles) {
                const styles = selected.userData.advancedStyles;
                let cssRules = [];
                
                // Border
                if (styles.borderStyle && styles.borderStyle !== 'none') {
                    cssRules.push(`border: ${styles.borderWidth || 1}px ${styles.borderStyle} ${styles.borderColor || '#000'}`);
                }
                
                // Box Shadow
                if (styles.shadowBlur > 0) {
                    const opacity = (styles.shadowOpacity || 50) / 100;
                    cssRules.push(`box-shadow: ${styles.shadowX || 0}px ${styles.shadowY || 0}px ${styles.shadowBlur}px ${styles.shadowSpread || 0}px rgba(0,0,0,${opacity})`);
                }
                
                // Transform
                let transforms = [];
                if (styles.translateX) transforms.push(`translateX(${styles.translateX}px)`);
                if (styles.translateY) transforms.push(`translateY(${styles.translateY}px)`);
                if (styles.scaleX !== 1 || styles.scaleY !== 1) transforms.push(`scale(${styles.scaleX || 1}, ${styles.scaleY || 1})`);
                if (styles.skewX) transforms.push(`skewX(${styles.skewX}deg)`);
                if (styles.skewY) transforms.push(`skewY(${styles.skewY}deg)`);
                if (transforms.length > 0) {
                    cssRules.push(`transform: ${transforms.join(' ')}`);
                }
                
                // Filters for images
                if (selected.userData.type === 'image') {
                    let filters = [];
                    if (styles.filterBlur > 0) filters.push(`blur(${styles.filterBlur}px)`);
                    if (styles.filterHue !== 0) filters.push(`hue-rotate(${styles.filterHue}deg)`);
                    if (styles.filterInvert > 0) filters.push(`invert(${styles.filterInvert}%)`);
                    if (styles.filterSepia > 0) filters.push(`sepia(${styles.filterSepia}%)`);
                    if (filters.length > 0) {
                        cssRules.push(`filter: ${filters.join(' ')}`);
                    }
                }
                
                cssText += cssRules.length > 0 ? cssRules.join('; ') : 'No styles applied';
            } else {
                cssText += 'No element selected';
            }
            
            preview.textContent = cssText;
        }

        function applyAdvancedStyles() {
            if (!selected) return;

            const styles = {
                // Border styles
                borderStyle: document.getElementById('adv-border-style').value,
                borderWidth: parseInt(document.getElementById('adv-border-width').value),
                borderColor: document.getElementById('adv-border-color').value,
                borderRadius: parseInt(document.getElementById('adv-border-radius').value),
                borderTopLeft: parseInt(document.getElementById('adv-border-top-left').value),
                borderTopRight: parseInt(document.getElementById('adv-border-top-right').value),
                borderBottomLeft: parseInt(document.getElementById('adv-border-bottom-left').value),
                borderBottomRight: parseInt(document.getElementById('adv-border-bottom-right').value),
                
                // Shadow styles
                shadowX: parseInt(document.getElementById('adv-shadow-x').value),
                shadowY: parseInt(document.getElementById('adv-shadow-y').value),
                shadowBlur: parseInt(document.getElementById('adv-shadow-blur').value),
                shadowSpread: parseInt(document.getElementById('adv-shadow-spread').value),
                shadowColor: document.getElementById('adv-shadow-color').value,
                shadowOpacity: parseInt(document.getElementById('adv-shadow-opacity').value),
                
                // Background styles
                bgType: document.getElementById('adv-bg-type').value,
                bgColor1: document.getElementById('adv-bg-color1').value,
                bgColor2: document.getElementById('adv-bg-color2').value,
                bgAngle: parseInt(document.getElementById('adv-bg-angle').value),
                bgSize: document.getElementById('adv-bg-size').value,
                bgPosition: document.getElementById('adv-bg-position').value,
                
                // Transform styles
                translateX: parseInt(document.getElementById('adv-translate-x').value),
                translateY: parseInt(document.getElementById('adv-translate-y').value),
                scaleX: parseFloat(document.getElementById('adv-scale-x').value),
                scaleY: parseFloat(document.getElementById('adv-scale-y').value),
                skewX: parseInt(document.getElementById('adv-skew-x').value),
                skewY: parseInt(document.getElementById('adv-skew-y').value),
                transitionDuration: parseFloat(document.getElementById('adv-transition-duration').value),
                transitionTiming: document.getElementById('adv-transition-timing').value
            };

            // Text-specific styles
            if (selected.userData.type === 'text') {
                styles.fontFamily = document.getElementById('adv-font-family').value;
                styles.textAlign = document.getElementById('adv-text-align').value;
                styles.textTransform = document.getElementById('adv-text-transform').value;
                styles.textDecoration = document.getElementById('adv-text-decoration').value;
                styles.letterSpacing = parseFloat(document.getElementById('adv-letter-spacing').value);
                styles.lineHeight = parseFloat(document.getElementById('adv-line-height').value);
                styles.textShadowX = parseInt(document.getElementById('adv-text-shadow-x').value);
                styles.textShadowY = parseInt(document.getElementById('adv-text-shadow-y').value);
                styles.textShadowBlur = parseInt(document.getElementById('adv-text-shadow-blur').value);
                styles.textShadowColor = document.getElementById('adv-text-shadow-color').value;
            }

            // Image-specific styles
            if (selected.userData.type === 'image') {
                styles.objectFit = document.getElementById('adv-object-fit').value;
                styles.objectPosition = document.getElementById('adv-object-position').value;
                styles.imageRendering = document.getElementById('adv-image-rendering').value;
                styles.mixBlendMode = document.getElementById('adv-mix-blend-mode').value;
                styles.filterBlur = parseFloat(document.getElementById('adv-filter-blur').value);
                styles.filterHue = parseInt(document.getElementById('adv-filter-hue').value);
                styles.filterInvert = parseInt(document.getElementById('adv-filter-invert').value);
                styles.filterSepia = parseInt(document.getElementById('adv-filter-sepia').value);
            }

            // Store advanced styles in element userData
            selected.userData.advancedStyles = styles;
            
            // Apply visual effects to the Three.js object
            applyAdvancedStylesToMesh(selected, styles);
            
            updateFilterPreview();
            saveState();
        }

        function applyAdvancedStylesToMesh(mesh, styles) {
            // Apply transform effects
            if (styles.translateX || styles.translateY) {
                mesh.position.x += (styles.translateX || 0) * 0.01;
                mesh.position.y += (styles.translateY || 0) * 0.01;
            }
            
            if (styles.scaleX !== 1 || styles.scaleY !== 1) {
                mesh.scale.x *= styles.scaleX || 1;
                mesh.scale.y *= styles.scaleY || 1;
            }
            
            // Apply rotation for skew effect (approximation)
            if (styles.skewX || styles.skewY) {
                mesh.rotation.z += (styles.skewX || 0) * 0.01;
            }
            
            // Apply filter effects for images
            if (mesh.userData.type === 'image' && styles.filterBlur > 0) {
                // Create a simple blur effect by adjusting material properties
                if (mesh.material.map) {
                    mesh.material.map.minFilter = THREE.LinearFilter;
                    mesh.material.map.magFilter = THREE.LinearFilter;
                }
            }
            
            // Update text properties if it's a text element
            if (mesh.userData.type === 'text' && styles.fontFamily) {
                const currentOptions = mesh.userData.options || {};
                currentOptions.fontFamily = styles.fontFamily;
                currentOptions.letterSpacing = styles.letterSpacing;
                currentOptions.lineHeight = styles.lineHeight;
                
                // Recreate text texture with new styles
                const texture = createTextTexture(mesh.userData.text, currentOptions);
                mesh.material.map = texture;
                mesh.material.needsUpdate = true;
            }
        }

        function resetAdvancedStyles() {
            if (!selected) return;
            
            // Reset all advanced style inputs to default values
            document.getElementById('adv-border-style').value = 'none';
            document.getElementById('adv-border-width').value = '1';
            document.getElementById('adv-border-color').value = '#000000';
            document.getElementById('adv-border-radius').value = '0';
            document.getElementById('adv-border-top-left').value = '0';
            document.getElementById('adv-border-top-right').value = '0';
            document.getElementById('adv-border-bottom-left').value = '0';
            document.getElementById('adv-border-bottom-right').value = '0';
            
            document.getElementById('adv-shadow-x').value = '0';
            document.getElementById('adv-shadow-y').value = '0';
            document.getElementById('adv-shadow-blur').value = '5';
            document.getElementById('adv-shadow-spread').value = '0';
            document.getElementById('adv-shadow-color').value = '#000000';
            document.getElementById('adv-shadow-opacity').value = '50';
            
            document.getElementById('adv-bg-type').value = 'color';
            document.getElementById('adv-bg-color1').value = '#ffffff';
            document.getElementById('adv-bg-color2').value = '#000000';
            document.getElementById('adv-bg-angle').value = '45';
            document.getElementById('adv-bg-size').value = 'auto';
            document.getElementById('adv-bg-position').value = 'center';
            
            document.getElementById('adv-translate-x').value = '0';
            document.getElementById('adv-translate-y').value = '0';
            document.getElementById('adv-scale-x').value = '1';
            document.getElementById('adv-scale-y').value = '1';
            document.getElementById('adv-skew-x').value = '0';
            document.getElementById('adv-skew-y').value = '0';
            document.getElementById('adv-transition-duration').value = '0.3';
            document.getElementById('adv-transition-timing').value = 'ease';
            
            // Reset text-specific controls
            if (document.getElementById('adv-font-family')) {
                document.getElementById('adv-font-family').value = 'Arial';
                document.getElementById('adv-text-align').value = 'left';
                document.getElementById('adv-text-transform').value = 'none';
                document.getElementById('adv-text-decoration').value = 'none';
                document.getElementById('adv-letter-spacing').value = '0';
                document.getElementById('adv-line-height').value = '1.2';
                document.getElementById('adv-text-shadow-x').value = '2';
                document.getElementById('adv-text-shadow-y').value = '2';
                document.getElementById('adv-text-shadow-blur').value = '4';
                document.getElementById('adv-text-shadow-color').value = '#000000';
            }
            
            // Reset image-specific controls
            if (document.getElementById('adv-object-fit')) {
                document.getElementById('adv-object-fit').value = 'fill';
                document.getElementById('adv-object-position').value = 'center';
                document.getElementById('adv-image-rendering').value = 'auto';
                document.getElementById('adv-mix-blend-mode').value = 'normal';
                document.getElementById('adv-filter-blur').value = '0';
                document.getElementById('adv-filter-hue').value = '0';
                document.getElementById('adv-filter-invert').value = '0';
                document.getElementById('adv-filter-sepia').value = '0';
            }
            
            // Clear stored advanced styles
            if (selected.userData.advancedStyles) {
                delete selected.userData.advancedStyles;
            }
            
            updateFilterPreview();
            saveState();
        }

        // === UTILITY FUNCTIONS ===
        function generateId() {
            return 'element_' + (++elementCounter);
        }

        function showLoading() {
            loading.style.display = 'block';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        // === STATE MANAGEMENT ===
        function saveState() {
            const state = {
                objects: objects.map(obj => ({
                    id: obj.userData.id,
                    type: obj.userData.type,
                    position: obj.position.toArray(),
                    rotation: obj.rotation.toArray(),
                    scale: obj.scale.toArray(),
                    text: obj.userData.text || '',
                    options: obj.userData.options || {},
                    advancedStyles: obj.userData.advancedStyles || {},
                    opacity: obj.material.opacity || 1
                }))
            };

            history = history.slice(0, historyIndex + 1);
            history.push(JSON.stringify(state));
            historyIndex++;

            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreState(JSON.parse(history[historyIndex]));
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                restoreState(JSON.parse(history[historyIndex]));
            }
        }

        function restoreState(state) {
            // Clear scene
            objects.forEach(obj => scene.remove(obj));
            objects.length = 0;

            // Restore objects
            state.objects.forEach(objData => {
                let obj;
                switch(objData.type) {
                    case 'text':
                        obj = createTextMesh(objData.text, objData.options);
                        break;
                    case 'shape':
                        obj = createShapeMesh();
                        break;
                    case 'rectangle':
                        obj = createRectangleMesh();
                        break;
                    case 'cube':
                        obj = createCubeMesh();
                        break;
                    case 'image':
                        // For images, we'll need to recreate them differently
                        // This is a simplified version
                        obj = createRectangleMesh();
                        obj.userData.type = 'image';
                        break;
                }

                if (obj) {
                    obj.userData.id = objData.id;
                    obj.userData.type = objData.type;
                    obj.userData.text = objData.text;
                    obj.userData.options = objData.options;
                    obj.userData.advancedStyles = objData.advancedStyles;
                    obj.position.fromArray(objData.position);
                    obj.rotation.fromArray(objData.rotation);
                    obj.scale.fromArray(objData.scale);
                    obj.material.opacity = objData.opacity || 1;
                    
                    // Apply advanced styles if they exist
                    if (objData.advancedStyles) {
                        applyAdvancedStylesToMesh(obj, objData.advancedStyles);
                    }
                    
                    scene.add(obj);
                    objects.push(obj);
                }
            });

            renderLayers();
            if (selected && !objects.includes(selected)) {
                selected = null;
                clearProperties();
            }
        }

        // === IMAGE HANDLING ===
        function handleImageUpload(file) {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.onload = () => {
                    const texture = new THREE.Texture(img);
                    texture.needsUpdate = true;
                    texture.colorSpace = THREE.SRGBColorSpace;

                    const material = new THREE.MeshBasicMaterial({ 
                        map: texture, 
                        transparent: true 
                    });
                    const geometry = new THREE.PlaneGeometry(1.6, 0.9);
                    const mesh = new THREE.Mesh(geometry, material);

                    mesh.userData.id = generateId();
                    mesh.userData.type = 'image';
                    mesh.userData.options = {
                        brightness: 100,
                        contrast: 100,
                        saturation: 100
                    };
                    mesh.position.set(0, 0, 0);

                    scene.add(mesh);
                    objects.push(mesh);
                    selectElement(mesh);
                    renderLayers();
                    saveState();
                };
                img.src = reader.result;
            };
            reader.readAsDataURL(file);
        }

        // === TEXT CREATION ===
        function createTextTexture(text, options) {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = options.bg;
            ctx.strokeStyle = options.border;
            ctx.lineWidth = options.borderWidth;

            const w = canvas.width, h = canvas.height;
            const r = options.radius || 10;

            ctx.beginPath();
            ctx.moveTo(r, 0);
            ctx.lineTo(w - r, 0);
            ctx.quadraticCurveTo(w, 0, w, r);
            ctx.lineTo(w, h - r);
            ctx.quadraticCurveTo(w, h, w - r, h);
            ctx.lineTo(r, h);
            ctx.quadraticCurveTo(0, h, 0, h - r);
            ctx.lineTo(0, r);
            ctx.quadraticCurveTo(0, 0, r, 0);
            ctx.closePath();
            ctx.fill();
            if (options.borderWidth > 0) ctx.stroke();

            // Apply advanced text styles if available
            const fontFamily = options.fontFamily || 'Arial';
            const letterSpacing = options.letterSpacing || 0;
            
            ctx.fillStyle = options.color;
            ctx.font = `${options.weight || 'normal'} ${options.size}px ${fontFamily}`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            // Apply letter spacing
            if (letterSpacing !== 0) {
                const chars = text.split('');
                const totalWidth = chars.reduce((width, char) => width + ctx.measureText(char).width + letterSpacing, 0) - letterSpacing;
                let x = (canvas.width - totalWidth) / 2;
                
                chars.forEach(char => {
                    ctx.fillText(char, x + ctx.measureText(char).width / 2, canvas.height / 2);
                    x += ctx.measureText(char).width + letterSpacing;
                });
            } else {
                ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            }

            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            return texture;
        }

        function createTextMesh(text, options) {
            const defaultOptions = {
                size: 32,
                color: "#ffffff",
                bg: "#000000",
                border: "#ff0000",
                borderWidth: 2,
                radius: 10,
                weight: 'normal',
                fontFamily: 'Arial',
                letterSpacing: 0,
                lineHeight: 1.2
            };
            const opts = { ...defaultOptions, ...options };

            const texture = createTextTexture(text, opts);
            const material = new THREE.MeshBasicMaterial({ 
                map: texture, 
                transparent: true 
            });
            const geometry = new THREE.PlaneGeometry(1.6, 0.8);
            const mesh = new THREE.Mesh(geometry, material);

            mesh.userData.text = text;
            mesh.userData.options = opts;
            mesh.userData.id = generateId();
            mesh.userData.type = 'text';
            return mesh;
        }

        function createShapeMesh() {
            const geometry = new THREE.CircleGeometry(0.5, 32);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, 
                transparent: true 
            });
            const mesh = new THREE.Mesh(geometry, material);

            mesh.userData.id = generateId();
            mesh.userData.type = 'shape';
            mesh.userData.options = { color: '#00ffff' };
            return mesh;
        }

        function createRectangleMesh() {
            const geometry = new THREE.PlaneGeometry(1.5, 1);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, 
                transparent: true 
            });
            const mesh = new THREE.Mesh(geometry, material);

            mesh.userData.id = generateId();
            mesh.userData.type = 'rectangle';
            mesh.userData.options = { color: '#00ffff' };
            return mesh;
        }

        function createCubeMesh() {
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, 
                transparent: true 
            });
            const mesh = new THREE.Mesh(geometry, material);

            mesh.userData.id = generateId();
            mesh.userData.type = 'cube';
            mesh.userData.options = { color: '#00ffff' };
            return mesh;
        }

        // === ELEMENT SELECTION ===
        function selectElement(obj) {
            selected = obj;
            updateProperties();
            updateLayersSelection();
            updateAdvancedStylingVisibility();
            updateFilterPreview();
        }

        function updateProperties() {
            if (!selected) {
                clearProperties();
                return;
            }

            propName.value = selected.userData.id || '';
            propX.value = selected.position.x;
            propY.value = selected.position.y;
            propZ.value = selected.position.z;
            propRotateX.value = THREE.MathUtils.radToDeg(selected.rotation.x);
            propRotateY.value = THREE.MathUtils.radToDeg(selected.rotation.y);
            propRotateZ.value = THREE.MathUtils.radToDeg(selected.rotation.z);
            propScale.value = selected.scale.x;
            propOpacity.value = (selected.material.opacity || 1) * 100;

            // Hide all property lines first
            hideAllPropertyLines();

            // Show relevant controls based on type
            if (selected.userData.type === 'text') {
                showTextProperties();
            } else if (selected.userData.type === 'image') {
                showImageProperties();
            } else if (['shape', 'rectangle', 'cube'].includes(selected.userData.type)) {
                showShapeProperties();
            }

            // Load advanced styles if they exist
            if (selected.userData.advancedStyles && isAdvancedStylingMode) {
                loadAdvancedStyles(selected.userData.advancedStyles);
            }
        }

        function loadAdvancedStyles(styles) {
            // Load border styles
            if (styles.borderStyle) document.getElementById('adv-border-style').value = styles.borderStyle;
            if (styles.borderWidth) document.getElementById('adv-border-width').value = styles.borderWidth;
            if (styles.borderColor) document.getElementById('adv-border-color').value = styles.borderColor;
            if (styles.borderRadius) document.getElementById('adv-border-radius').value = styles.borderRadius;
            
            // Load shadow styles
            if (styles.shadowX !== undefined) document.getElementById('adv-shadow-x').value = styles.shadowX;
            if (styles.shadowY !== undefined) document.getElementById('adv-shadow-y').value = styles.shadowY;
            if (styles.shadowBlur !== undefined) document.getElementById('adv-shadow-blur').value = styles.shadowBlur;
            if (styles.shadowSpread !== undefined) document.getElementById('adv-shadow-spread').value = styles.shadowSpread;
            if (styles.shadowColor) document.getElementById('adv-shadow-color').value = styles.shadowColor;
            if (styles.shadowOpacity !== undefined) document.getElementById('adv-shadow-opacity').value = styles.shadowOpacity;
            
            // Load transform styles
            if (styles.translateX !== undefined) document.getElementById('adv-translate-x').value = styles.translateX;
            if (styles.translateY !== undefined) document.getElementById('adv-translate-y').value = styles.translateY;
            if (styles.scaleX !== undefined) document.getElementById('adv-scale-x').value = styles.scaleX;
            if (styles.scaleY !== undefined) document.getElementById('adv-scale-y').value = styles.scaleY;
            if (styles.skewX !== undefined) document.getElementById('adv-skew-x').value = styles.skewX;
            if (styles.skewY !== undefined) document.getElementById('adv-skew-y').value = styles.skewY;
            
            // Load text-specific styles
            if (selected.userData.type === 'text') {
                if (styles.fontFamily) document.getElementById('adv-font-family').value = styles.fontFamily;
                if (styles.textAlign) document.getElementById('adv-text-align').value = styles.textAlign;
                if (styles.textTransform) document.getElementById('adv-text-transform').value = styles.textTransform;
                if (styles.textDecoration) document.getElementById('adv-text-decoration').value = styles.textDecoration;
                if (styles.letterSpacing !== undefined) document.getElementById('adv-letter-spacing').value = styles.letterSpacing;
                if (styles.lineHeight !== undefined) document.getElementById('adv-line-height').value = styles.lineHeight;
            }
            
            // Load image-specific styles
            if (selected.userData.type === 'image') {
                if (styles.objectFit) document.getElementById('adv-object-fit').value = styles.objectFit;
                if (styles.objectPosition) document.getElementById('adv-object-position').value = styles.objectPosition;
                if (styles.imageRendering) document.getElementById('adv-image-rendering').value = styles.imageRendering;
                if (styles.mixBlendMode) document.getElementById('adv-mix-blend-mode').value = styles.mixBlendMode;
                if (styles.filterBlur !== undefined) document.getElementById('adv-filter-blur').value = styles.filterBlur;
                if (styles.filterHue !== undefined) document.getElementById('adv-filter-hue').value = styles.filterHue;
                if (styles.filterInvert !== undefined) document.getElementById('adv-filter-invert').value = styles.filterInvert;
                if (styles.filterSepia !== undefined) document.getElementById('adv-filter-sepia').value = styles.filterSepia;
            }
        }

        function hideAllPropertyLines() {
            const lines = [
                'text-content-line', 'text-size-line', 'text-weight-line',
                'main-color-line', 'bg-color-line', 'border-color-line',
                'border-width-line', 'border-radius-line', 'image-brightness-line',
                'image-contrast-line', 'image-saturation-line'
            ];
            lines.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
        }

        function showTextProperties() {
            const opt = selected.userData.options || {};
            propText.value = selected.userData.text || '';
            propTextSize.value = opt.size || 32;
            propTextWeight.value = opt.weight || 'normal';
            propMainColor.value = opt.color || '#ffffff';
            propBgColor.value = opt.bg || '#000000';
            propBorderColor.value = opt.border || '#ff0000';
            propBorderWidth.value = opt.borderWidth || 2;
            propBorderRadius.value = opt.radius || 10;

            document.getElementById('text-content-line').style.display = 'grid';
            document.getElementById('text-size-line').style.display = 'grid';
            document.getElementById('text-weight-line').style.display = 'grid';
            document.getElementById('main-color-line').style.display = 'grid';
            document.getElementById('bg-color-line').style.display = 'grid';
            document.getElementById('border-color-line').style.display = 'grid';
            document.getElementById('border-width-line').style.display = 'grid';
            document.getElementById('border-radius-line').style.display = 'grid';
        }

        function showImageProperties() {
            const opt = selected.userData.options || {};
            propImageBrightness.value = opt.brightness || 100;
            propImageContrast.value = opt.contrast || 100;
            propImageSaturation.value = opt.saturation || 100;

            document.getElementById('image-brightness-line').style.display = 'grid';
            document.getElementById('image-contrast-line').style.display = 'grid';
            document.getElementById('image-saturation-line').style.display = 'grid';
        }

        function showShapeProperties() {
            const opt = selected.userData.options || {};
            propMainColor.value = opt.color || '#00ffff';
            document.getElementById('main-color-line').style.display = 'grid';
        }

        function clearProperties() {
            propName.value = '';
            propX.value = '0';
            propY.value = '0';
            propZ.value = '0';
            propRotateX.value = '0';
            propRotateY.value = '0';
            propRotateZ.value = '0';
            propScale.value = '1';
            propOpacity.value = '100';
            propText.value = '';
            hideAllPropertyLines();
        }

        function applyPropertiesToElement() {
            if (!selected) return;

            selected.position.x = parseFloat(propX.value);
            selected.position.y = parseFloat(propY.value);
            selected.position.z = parseFloat(propZ.value);
            selected.rotation.x = THREE.MathUtils.degToRad(parseFloat(propRotateX.value));
            selected.rotation.y = THREE.MathUtils.degToRad(parseFloat(propRotateY.value));
            selected.rotation.z = THREE.MathUtils.degToRad(parseFloat(propRotateZ.value));

            const scale = parseFloat(propScale.value);
            selected.scale.set(scale, scale, scale);
            selected.material.opacity = parseFloat(propOpacity.value) / 100;

            // Update element name
            if (propName.value !== selected.userData.id) {
                selected.userData.id = propName.value;
                renderLayers();
            }

            // Update based on type
            if (selected.userData.type === 'text') {
                updateTextProperties();
            } else if (selected.userData.type === 'image') {
                updateImageProperties();
            } else if (['shape', 'rectangle', 'cube'].includes(selected.userData.type)) {
                updateShapeProperties();
            }
        }

        function updateTextProperties() {
            if (!selected || selected.userData.type !== 'text') return;

            const opt = selected.userData.options;
            const text = propText.value;
            opt.size = parseInt(propTextSize.value);
            opt.weight = propTextWeight.value;
            opt.color = propMainColor.value;
            opt.bg = propBgColor.value;
            opt.border = propBorderColor.value;
            opt.borderWidth = parseInt(propBorderWidth.value);
            opt.radius = parseInt(propBorderRadius.value);

            const texture = createTextTexture(text, opt);
            selected.material.map = texture;
            selected.material.needsUpdate = true;
            selected.userData.text = text;
        }

        function updateImageProperties() {
            if (!selected || selected.userData.type !== 'image') return;

            const opt = selected.userData.options;
            opt.brightness = parseInt(propImageBrightness.value);
            opt.contrast = parseInt(propImageContrast.value);
            opt.saturation = parseInt(propImageSaturation.value);

            // Apply filters to material
            const brightness = opt.brightness / 100;
            const contrast = opt.contrast / 100;
            selected.material.color.setRGB(brightness * contrast, brightness * contrast, brightness * contrast);
        }

        function updateShapeProperties() {
            if (!selected || !['shape', 'rectangle', 'cube'].includes(selected.userData.type)) return;

            const opt = selected.userData.options;
            opt.color = propMainColor.value;
            selected.material.color.setHex(opt.color.replace('#', '0x'));
        }

        // === LAYER MANAGEMENT ===
        function moveLayerUp() {
            if (!selected) return;
            const index = objects.indexOf(selected);
            if (index < objects.length - 1) {
                objects.splice(index, 1);
                objects.splice(index + 1, 0, selected);
                renderLayers();
                saveState();
            }
        }

        function moveLayerDown() {
            if (!selected) return;
            const index = objects.indexOf(selected);
            if (index > 0) {
                objects.splice(index, 1);
                objects.splice(index - 1, 0, selected);
                renderLayers();
                saveState();
            }
        }

        function duplicateLayer() {
            if (!selected) return;

            let newObj;
            switch(selected.userData.type) {
                case 'text':
                    newObj = createTextMesh(selected.userData.text, selected.userData.options);
                    break;
                case 'shape':
                    newObj = createShapeMesh();
                    break;
                case 'rectangle':
                    newObj = createRectangleMesh();
                    break;
                case 'cube':
                    newObj = createCubeMesh();
                    break;
            }

            if (newObj) {
                newObj.position.copy(selected.position);
                newObj.position.x += 0.2;
                newObj.position.y += 0.2;
                newObj.rotation.copy(selected.rotation);
                newObj.scale.copy(selected.scale);
                newObj.material.opacity = selected.material.opacity;

                // Copy advanced styles if they exist
                if (selected.userData.advancedStyles) {
                    newObj.userData.advancedStyles = { ...selected.userData.advancedStyles };
                }

                scene.add(newObj);
                objects.push(newObj);
                selectElement(newObj);
                renderLayers();
                saveState();
            }
        }

        function deleteLayer() {
            if (!selected) return;

            scene.remove(selected);
            const index = objects.indexOf(selected);
            if (index > -1) {
                objects.splice(index, 1);
            }

            selected = null;
            clearProperties();
            renderLayers();
            saveState();
        }

        // === 3D PRESETS ===
        function apply3DPreset(preset) {
            if (!selected) return;

            switch(preset) {
                case 'flip':
                    propRotateY.value = '180';
                    propZ.value = '0.5';
                    break;
                case 'cube':
                    animateObject(selected, 'spin');
                    return;
                case 'float':
                    animateObject(selected, 'float');
                    return;
                case 'reset':
                    propRotateX.value = '0';
                    propRotateY.value = '0';
                    propRotateZ.value = '0';
                    propZ.value = '0';
                    propScale.value = '1';
                    break;
            }
            applyPropertiesToElement();
            saveState();
        }

        function animateObject(obj, type) {
            const startTime = Date.now();
            const duration = type === 'spin' ? 6000 : 4000;

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / duration;

                if (progress < 1) {
                    if (type === 'spin') {
                        obj.rotation.x = progress * Math.PI * 4;
                        obj.rotation.y = progress * Math.PI * 4;
                        obj.rotation.z = progress * Math.PI * 4;
                    } else if (type === 'float') {
                        obj.position.z = Math.sin(progress * Math.PI * 4) * 0.5;
                        obj.rotation.y = progress * Math.PI * 2;
                    }
                    requestAnimationFrame(animate);
                } else {
                    if (type === 'spin') {
                        obj.rotation.set(0, 0, 0);
                    } else if (type === 'float') {
                        obj.position.z = 0;
                        obj.rotation.y = 0;
                    }
                    updateProperties();
                }
            }
            animate();
        }

        // === LAYERS MANAGEMENT ===
        function renderLayers() {
            layersContent.innerHTML = '';
            [...objects].reverse().forEach((obj, i) => {
                const layerItem = document.createElement('div');
                layerItem.className = 'layer-item';
                layerItem.innerHTML = `
                    <svg class="layer-icon" viewBox="0 0 24 24">
                        ${getLayerIcon(obj.userData.type)}
                    </svg>
                    ${obj.userData.id}
                    <div class="layer-controls">
                        <div class="layer-control-btn" onclick="moveLayerUp()" title="Move Up">‚Üë</div>
                        <div class="layer-control-btn" onclick="moveLayerDown()" title="Move Down">‚Üì</div>
                        <div class="layer-control-btn" onclick="duplicateLayer()" title="Duplicate">‚ßâ</div>
                        <div class="layer-control-btn" onclick="deleteLayer()" title="Delete">√ó</div>
                    </div>
                `;

                if (obj === selected) {
                    layerItem.classList.add('selected');
                }

                layerItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('layer-control-btn')) {
                        selectElement(obj);
                    }
                });

                layersContent.appendChild(layerItem);
            });
        }

        function getLayerIcon(type) {
            switch(type) {
                case 'text':
                    return '<path d="M4 17v-2h8v2H4zm0-6V9h12v2H4zm0-4V5h16v2H4z"/>';
                case 'shape':
                    return '<circle cx="12" cy="12" r="6"/>';
                case 'rectangle':
                    return '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>';
                case 'cube':
                    return '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>';
                case 'image':
                    return '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8" cy="8" r="1.5"/><path d="M21 15l-5-5-5 5"/>';
                default:
                    return '<circle cx="12" cy="12" r="6"/>';
            }
        }

        function updateLayersSelection() {
            const layerItems = layersContent.querySelectorAll('.layer-item');
            layerItems.forEach(item => item.classList.remove('selected'));

            if (!selected) return;

            const idx = objects.findIndex(obj => obj === selected);
            if (idx === -1) return;

            const reverseIdx = objects.length - 1 - idx;
            if (layerItems[reverseIdx]) {
                layerItems[reverseIdx].classList.add('selected');
            }
        }

        // === EXPORT FUNCTIONS ===
        function exportWithSettings() {
            showLoading();
            try {
                const quality = parseFloat(exportQuality.value);
                const format = exportFormat.value;
                const width = parseInt(exportWidth.value);
                const height = parseInt(exportHeight.value);
                const filename = exportFilename.value || 'editIQ-export';

                // Temporarily increase render size for quality
                const originalWidth = renderer.domElement.width;
                const originalHeight = renderer.domElement.height;

                renderer.setSize(width * quality, height * quality);
                renderer.render(scene, camera);

                const link = document.createElement('a');
                link.download = `${filename}.${format}`;

                if (format === 'jpg') {
                    link.href = renderer.domElement.toDataURL('image/jpeg', 0.95);
                } else if (format === 'webp') {
                    link.href = renderer.domElement.toDataURL('image/webp', 0.95);
                } else {
                    link.href = renderer.domElement.toDataURL('image/png');
                }

                link.click();

                // Restore original size
                renderer.setSize(originalWidth, originalHeight);

                exportModal.style.display = 'none';
            } catch (error) {
                console.error('Export failed:', error);
            } finally {
                hideLoading();
            }
        }

        // === CANVAS RATIO MANAGEMENT ===
        function updateCanvasSize(width, height) {
            currentCanvasWidth = width;
            currentCanvasHeight = height;
            canvasWidthInput.value = width;
            canvasHeightInput.value = height;
            exportWidth.value = width;
            exportHeight.value = height;

            // Calculate scale to fit in viewport with exact ratio
            const container = canvasInner.parentElement;
            const maxWidth = container.clientWidth - 40;
            const maxHeight = container.clientHeight - 40;
            
            const scaleX = maxWidth / width;
            const scaleY = maxHeight / height;
            canvasScale = Math.min(scaleX, scaleY, 1);

            // Update canvas inner size to exact ratio
            canvasInner.style.width = (width * canvasScale) + 'px';
            canvasInner.style.height = (height * canvasScale) + 'px';

            // Update renderer size
            renderer.setSize(width * canvasScale, height * canvasScale);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            // Update display
            updateCanvasDisplay();
        }

        function updateCanvasDisplay() {
            const ratio = calculateRatio(currentCanvasWidth, currentCanvasHeight);
            canvasSizeDisplay.textContent = `${currentCanvasWidth} √ó ${currentCanvasHeight} (${ratio})`;
            canvasZoomDisplay.textContent = `${Math.round(canvasScale * 100)}%`;
            canvasRatioIndicator.textContent = ratio;
        }

        function calculateRatio(width, height) {
            const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
            const divisor = gcd(width, height);
            return `${width / divisor}:${height / divisor}`;
        }

        function applyCanvasPreset(presetKey) {
            const preset = canvasPresets[presetKey];
            if (preset) {
                updateCanvasSize(preset.width, preset.height);
            }
        }

        function centerAllContent() {
            objects.forEach(obj => {
                obj.position.x = 0;
                obj.position.y = 0;
            });
            if (selected) {
                updateProperties();
            }
            saveState();
        }

        function fitContentToCanvas() {
            if (objects.length === 0) return;

            // Calculate bounding box of all objects
            let minX = Infinity, maxX = -Infinity;
            let minY = Infinity, maxY = -Infinity;

            objects.forEach(obj => {
                const box = new THREE.Box3().setFromObject(obj);
                minX = Math.min(minX, box.min.x);
                maxX = Math.max(maxX, box.max.x);
                minY = Math.min(minY, box.min.y);
                maxY = Math.max(maxY, box.max.y);
            });

            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;

            // Calculate scale to fit content
            const canvasAspect = currentCanvasWidth / currentCanvasHeight;
            const contentAspect = contentWidth / contentHeight;
            let scale;

            if (contentAspect > canvasAspect) {
                scale = (currentCanvasWidth * 0.8) / (contentWidth * 100);
            } else {
                scale = (currentCanvasHeight * 0.8) / (contentHeight * 100);
            }

            // Apply transformations
            objects.forEach(obj => {
                obj.position.x = (obj.position.x - centerX) * scale;
                obj.position.y = (obj.position.y - centerY) * scale;
                obj.scale.multiplyScalar(scale);
            });

            if (selected) {
                updateProperties();
            }
            saveState();
        }

        function updateCanvasBackground() {
            const color = canvasBackgroundInput.value;
            renderer.setClearColor(color);
        }

        // === REAL-TIME COLLABORATION SYSTEM ===
        class RealTimeCollaboration {
            constructor() {
                this.sessionId = this.getSessionFromUrl() || this.generateSessionId();
                this.userId = this.generateUserId();
                this.userName = `User ${this.userId.slice(-4)}`;
                this.isCollaborationSession = !!this.getSessionFromUrl();
                this.broadcastChannel = null;
                this.onlineUsers = new Map();
                this.unreadMessages = 0;
                this.isChatOpen = false;
                
                this.init();
            }

            generateSessionId() {
                return 'session_' + Math.random().toString(36).substr(2, 9);
            }

            generateUserId() {
                return 'user_' + Math.random().toString(36).substr(2, 9);
            }

            getSessionFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('session');
            }

            init() {
                if (this.isCollaborationSession) {
                    this.setupBroadcastChannel();
                    this.joinSession();
                }
                this.setupEventListeners();
                this.updateUI();
            }

            setupBroadcastChannel() {
                this.broadcastChannel = new BroadcastChannel(`editiq_${this.sessionId}`);
                this.broadcastChannel.addEventListener('message', this.handleMessage.bind(this));
            }

            joinSession() {
                this.onlineUsers.set(this.userId, {
                    id: this.userId,
                    name: this.userName,
                    joinedAt: Date.now()
                });

                this.broadcast({
                    type: 'user_joined',
                    user: {
                        id: this.userId,
                        name: this.userName,
                        joinedAt: Date.now()
                    }
                });

                this.addSystemMessage(`You joined as ${this.userName}`);
                this.updateOnlineUsers();
            }

            broadcast(message) {
                if (this.broadcastChannel) {
                    this.broadcastChannel.postMessage({
                        ...message,
                        senderId: this.userId,
                        timestamp: Date.now()
                    });
                }
            }

            handleMessage(event) {
                const { data } = event;
                
                if (data.senderId === this.userId) return; // Ignore own messages

                switch (data.type) {
                    case 'user_joined':
                        this.onlineUsers.set(data.user.id, data.user);
                        this.addSystemMessage(`${data.user.name} joined the session`);
                        this.updateOnlineUsers();
                        break;
                    
                    case 'user_left':
                        this.onlineUsers.delete(data.userId);
                        this.addSystemMessage(`${data.userName} left the session`);
                        this.updateOnlineUsers();
                        break;
                    
                    case 'chat_message':
                        this.addChatMessage(data.userName, data.message, 'other');
                        break;
                    
                    case 'element_update':
                        // Handle real-time element updates
                        this.handleElementUpdate(data);
                        break;
                }
            }

            setupEventListeners() {
                // Chat functionality
                document.getElementById('chat-toggle').addEventListener('click', this.toggleChat.bind(this));
                document.getElementById('chat-close').addEventListener('click', this.closeChat.bind(this));
                document.getElementById('chat-send').addEventListener('click', this.sendMessage.bind(this));
                document.getElementById('chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Invite functionality
                document.getElementById('invite-btn').addEventListener('click', this.showInviteModal.bind(this));
                document.getElementById('close-invite-modal').addEventListener('click', this.closeInviteModal.bind(this));
                document.getElementById('close-invite').addEventListener('click', this.closeInviteModal.bind(this));
                document.getElementById('copy-invite-link').addEventListener('click', this.copyInviteLink.bind(this));

                // Handle page unload
                window.addEventListener('beforeunload', () => {
                    this.broadcast({
                        type: 'user_left',
                        userId: this.userId,
                        userName: this.userName
                    });
                });
            }

            updateUI() {
                const status = document.getElementById('collaboration-status');
                if (this.isCollaborationSession) {
                    status.textContent = 'üü¢ Connected to collaboration session';
                    status.classList.add('show');
                } else {
                    status.textContent = 'üü° Ready for collaboration';
                    status.classList.add('show');
                    setTimeout(() => status.classList.remove('show'), 3000);
                }
            }

            updateOnlineUsers() {
                const container = document.getElementById('online-users');
                container.innerHTML = '';

                this.onlineUsers.forEach((user, userId) => {
                    const userElement = document.createElement('div');
                    userElement.className = `user-indicator ${userId === this.userId ? 'self' : ''}`;
                    userElement.title = user.name;
                    userElement.innerHTML = `
                        <div class="user-avatar">
                            ${userId === this.userId ? 'üë§' : 'üë•'}
                            <div class="user-status"></div>
                        </div>
                        <span class="user-name">${user.name}</span>
                    `;
                    container.appendChild(userElement);
                });
            }

            toggleChat() {
                const chatPanel = document.getElementById('chat-panel');
                const chatToggle = document.getElementById('chat-toggle');
                
                if (this.isChatOpen) {
                    this.closeChat();
                } else {
                    chatPanel.classList.add('show');
                    chatToggle.classList.add('active');
                    this.isChatOpen = true;
                    this.unreadMessages = 0;
                    this.updateChatToggleIcon();
                    this.scrollChatToBottom();
                }
            }

            closeChat() {
                const chatPanel = document.getElementById('chat-panel');
                const chatToggle = document.getElementById('chat-toggle');
                chatPanel.classList.remove('show');
                chatToggle.classList.remove('active');
                this.isChatOpen = false;
            }

            updateChatToggleIcon() {
                const chatToggle = document.getElementById('chat-toggle');
                if (this.unreadMessages > 0 && !this.isChatOpen) {
                    chatToggle.innerHTML = `üí¨ <span class="message-badge">${this.unreadMessages > 99 ? '99+' : this.unreadMessages}</span>`;
                } else {
                    chatToggle.innerHTML = 'üí¨';
                }
            }

            sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                
                if (message) {
                    this.addChatMessage(this.userName, message, 'self');
                    input.value = '';
                    
                    if (this.isCollaborationSession) {
                        this.broadcast({
                            type: 'chat_message',
                            userName: this.userName,
                            message: message
                        });
                    }
                }
            }

            addSystemMessage(content) {
                this.addChatMessage('System', content, 'system');
            }

            addChatMessage(sender, content, type) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageElement = document.createElement('div');
                messageElement.className = `chat-message ${type}`;
                
                const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="sender">${sender}</div>
                    <div class="content">${content}</div>
                    <div class="timestamp">${timestamp}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
                this.scrollChatToBottom();
                
                // Update unread count if chat is closed and it's not from current user
                if (!this.isChatOpen && type !== 'self' && type !== 'system') {
                    this.unreadMessages++;
                    this.updateChatToggleIcon();
                }
            }

            scrollChatToBottom() {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }

            showInviteModal() {
                const modal = document.getElementById('invite-modal');
                const inviteLink = document.getElementById('invite-link');
                const shareUrl = `${window.location.origin}${window.location.pathname}?session=${this.sessionId}`;
                inviteLink.value = shareUrl;
                modal.style.display = 'block';
            }

            closeInviteModal() {
                document.getElementById('invite-modal').style.display = 'none';
            }

            copyInviteLink() {
                const inviteLink = document.getElementById('invite-link');
                inviteLink.select();
                document.execCommand('copy');
                
                const copyBtn = document.getElementById('copy-invite-link');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Copied!';
                copyBtn.style.background = 'var(--success-color)';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            }

            handleElementUpdate(data) {
                // Handle real-time element updates from other users
                // This would sync changes to the 3D scene
                console.log('Element update received:', data);
            }

            syncElementChange(elementData) {
                if (this.isCollaborationSession) {
                    this.broadcast({
                        type: 'element_update',
                        elementData: elementData
                    });
                }
            }
        }

        // Initialize collaboration system
        const collaboration = new RealTimeCollaboration();

        // === EVENT LISTENERS ===

        // Version switcher (theme switcher)
        versionSwitcher.addEventListener('click', switchTheme);

        // User profile dropdown
        userProfile.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('show');
        });

        document.addEventListener('click', () => {
            profileDropdown.classList.remove('show');
        });

        // Export modal
        exportBtn.addEventListener('click', () => {
            exportModal.style.display = 'block';
            exportWidth.value = currentCanvasWidth;
            exportHeight.value = currentCanvasHeight;
        });

        closeModal.addEventListener('click', () => {
            exportModal.style.display = 'none';
        });

        cancelExport.addEventListener('click', () => {
            exportModal.style.display = 'none';
        });

        confirmExport.addEventListener('click', exportWithSettings);

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === exportModal) {
                exportModal.style.display = 'none';
            }
            const inviteModal = document.getElementById('invite-modal');
            if (e.target === inviteModal) {
                collaboration.closeInviteModal();
            }
        });

        // Styling mode buttons
        document.getElementById('basic-styling').addEventListener('click', toggleBasicStyling);
        document.getElementById('advanced-styling').addEventListener('click', toggleAdvancedStyling);

        // Advanced styling controls
        document.getElementById('apply-advanced-styles').addEventListener('click', applyAdvancedStyles);
        document.getElementById('reset-advanced-styles').addEventListener('click', resetAdvancedStyles);

        // Add event listeners for real-time filter preview updates
        const advancedInputs = [
            'adv-border-style', 'adv-border-width', 'adv-border-color', 'adv-border-radius',
            'adv-shadow-x', 'adv-shadow-y', 'adv-shadow-blur', 'adv-shadow-spread', 'adv-shadow-color', 'adv-shadow-opacity',
            'adv-translate-x', 'adv-translate-y', 'adv-scale-x', 'adv-scale-y', 'adv-skew-x', 'adv-skew-y',
            'adv-filter-blur', 'adv-filter-hue', 'adv-filter-invert', 'adv-filter-sepia'
        ];

        advancedInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateFilterPreview);
            }
        });

        // Tool buttons
        addTextBtn.addEventListener('click', () => {
            const mesh = createTextMesh('Edit Me');
            scene.add(mesh);
            objects.push(mesh);
            selectElement(mesh);
            renderLayers();
            saveState();
        });

        addShapeBtn.addEventListener('click', () => {
            const mesh = createShapeMesh();
            scene.add(mesh);
            objects.push(mesh);
            selectElement(mesh);
            renderLayers();
            saveState();
        });

        addRectangleBtn.addEventListener('click', () => {
            const mesh = createRectangleMesh();
            scene.add(mesh);
            objects.push(mesh);
            selectElement(mesh);
            renderLayers();
            saveState();
        });

        addCubeBtn.addEventListener('click', () => {
            const mesh = createCubeMesh();
            scene.add(mesh);
            objects.push(mesh);
            selectElement(mesh);
            renderLayers();
            saveState();
        });

        addImageBtn.addEventListener('click', () => {
            fileImageInput.click();
        });

        fileImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            handleImageUpload(file);
            fileImageInput.value = '';
        });

        // Property controls
        [propName, propX, propY, propZ, propRotateX, propRotateY, propRotateZ, 
         propScale, propOpacity, propText, propTextSize, propTextWeight, 
         propMainColor, propBgColor, propBorderColor, propBorderWidth, 
         propBorderRadius, propImageBrightness, propImageContrast, propImageSaturation].forEach(input => {
            if (input) {
                input.addEventListener('input', applyPropertiesToElement);
            }
        });

        // 3D Preset buttons
        document.getElementById('preset-flip').addEventListener('click', () => apply3DPreset('flip'));
        document.getElementById('preset-cube').addEventListener('click', () => apply3DPreset('cube'));
        document.getElementById('preset-float').addEventListener('click', () => apply3DPreset('float'));
        document.getElementById('preset-reset').addEventListener('click', () => apply3DPreset('reset'));

        // Layer control buttons
        document.getElementById('layer-up').addEventListener('click', moveLayerUp);
        document.getElementById('layer-down').addEventListener('click', moveLayerDown);
        document.getElementById('layer-duplicate').addEventListener('click', duplicateLayer);
        document.getElementById('layer-delete').addEventListener('click', deleteLayer);

        // Keyboard shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redo();
                        } else {
                            undo();
                        }
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                    case 's':
                        e.preventDefault();
                        break;
                    case 'd':
                        e.preventDefault();
                        duplicateLayer();
                        break;
                }
            } else if (e.key === 'Delete' && selected) {
                deleteLayer();
            }
        });

        // Top bar buttons
        document.getElementById('btn-undo').addEventListener('click', undo);
        document.getElementById('btn-redo').addEventListener('click', redo);

        document.getElementById('btn-new').addEventListener('click', () => {
            if (confirm('Create new project? This will clear the current canvas.')) {
                objects.forEach(obj => scene.remove(obj));
                objects.length = 0;
                selected = null;
                clearProperties();
                renderLayers();
                history = [];
                historyIndex = -1;
                saveState();
            }
        });

        document.getElementById('btn-save').addEventListener('click', () => {
            const projectData = {
                version: 'v0.1',
                objects: objects.map(obj => ({
                    id: obj.userData.id,
                    type: obj.userData.type,
                    position: obj.position.toArray(),
                    rotation: obj.rotation.toArray(),
                    scale: obj.scale.toArray(),
                    text: obj.userData.text || '',
                    options: obj.userData.options || {},
                    advancedStyles: obj.userData.advancedStyles || {},
                    opacity: obj.material.opacity || 1
                }))
            };

            const blob = new Blob([JSON.stringify(projectData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'editIQ-project.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Zoom controls (camera controls)
        document.getElementById('zoom-in').addEventListener('click', () => {
            camera.position.z = Math.max(0.5, camera.position.z - 0.2);
            zoomLevel.textContent = Math.round((3 / camera.position.z) * 100) + '%';
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            camera.position.z = Math.min(10, camera.position.z + 0.2);
            zoomLevel.textContent = Math.round((3 / camera.position.z) * 100) + '%';
        });

        document.getElementById('zoom-reset').addEventListener('click', () => {
            camera.position.z = 3;
            zoomLevel.textContent = '100%';
        });

        // Canvas preset and size controls
        canvasPresetSelector.addEventListener('change', (e) => {
            if (e.target.value) {
                applyCanvasPreset(e.target.value);
            }
        });

        canvasWidthInput.addEventListener('input', () => {
            updateCanvasSize(parseInt(canvasWidthInput.value), parseInt(canvasHeightInput.value));
        });

        canvasHeightInput.addEventListener('input', () => {
            updateCanvasSize(parseInt(canvasWidthInput.value), parseInt(canvasHeightInput.value));
        });

        canvasBackgroundInput.addEventListener('change', updateCanvasBackground);

        document.getElementById('center-content').addEventListener('click', centerAllContent);
        document.getElementById('fit-content').addEventListener('click', fitContentToCanvas);

        // Initialize basic styling mode
        toggleBasicStyling();
    </script>
</body>
</html>
